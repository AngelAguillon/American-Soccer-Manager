<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes"> <title>American Soccer Manager 2026</title>
    
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiQW1lcmljYW4gU29jY2VyIE1hbmFnZXIiLCJzaG9ydF9uYW1lIjoiQVNNIDIwMjYiLCJzdGFydF91cmwiOiIuLyIsImRpc3BsYXkiOiJzdGFuZGFxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzFhMWExYSIsInRoZW1lX2NvbG9yIjoiI2Q0YWYzNyIsImljb25zIjpbeyJzcmMiOiJodHRwczovL2V4YW1wbGUuY29tL2ljb24ucG5nIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyJdfQ==">
    <title>American Soccer Manager 2026</title>
    <style>
        /* --- GLOBAL THEME --- */
        body {
            background: radial-gradient(circle at center, #1a1a1a, #000);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            touch-action: manipulation; /* Improves touch response */
            -webkit-user-select: none; /* Disables text selection on iPhone */
            user-select: none;
        }
		
		/* Scroll Hint Styles */
		.scroll-hint {
			display: none; /* Hidden on desktop */
		}

		/* Animation for the bounce */
		@keyframes bounceRight {
			0%, 100% { transform: translateX(0); }
			50% { transform: translateX(5px); }
		}

		/* --- MOBILE RESPONSIVE OVERRIDES --- */
        @media (max-width: 768px) {
            body {
                padding-bottom: env(safe-area-inset-bottom); /* Save space for home bar */
            }

            /* 1. Fix Big Title Text */
            h1 { font-size: 2.5rem; letter-spacing: 2px; }
            h2 { font-size: 1.5rem; }

            /* 2. Stack Layout & Scroll */
            .matchday-container {
                flex-direction: column;
                overflow-y: auto;
                height: auto;
                -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */
            }

            /* 3. Top Scrollable Menu */
            .sidebar-menu {
                width: 100%;
                height: auto;
                min-width: unset;
                border-right: none;
                border-bottom: 3px solid #d4af37;
                flex-direction: row;
                overflow-x: auto;
                white-space: nowrap;
                padding: 10px;
                position: sticky;
                top: 0;
                z-index: 100;
                background: #1a1a1a;
                box-shadow: 0 5px 15px rgba(0,0,0,0.5);
                
                /* Hide scrollbar visually but keep functionality */
                -ms-overflow-style: none;  /* IE and Edge */
                scrollbar-width: none;  /* Firefox */
            }
            .sidebar-menu::-webkit-scrollbar {
                display: none;
            }

            .menu-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
                flex: 0 0 auto; /* Don't shrink buttons */
            }

            /* 4. Restore the Bouncing Arrow Hint */
            .scroll-hint {
                display: flex !important; /* Force show on mobile */
            }

            /* 5. Fix Field & Player Scaling */
            .tactical-view {
                overflow: visible; /* Let the field breathe */
                height: auto;
            }

            .soccer-field {
                width: 95vw;
                height: auto;
                aspect-ratio: 2 / 3;
                margin: 20px 0;
            }

            /* Shrink player cards on mobile field so they don't overlap */
            .player-position {
                transform: translate(-50%, -50%) scale(0.75); /* 75% size */
                /* Fix touch targets after scaling */
                transform-origin: center center;
            }
            
            /* Remove hover effects on mobile to prevent sticky states */
            .player-position:hover {
                transform: translate(-50%, -50%) scale(0.75); 
                box-shadow: none;
                z-index: 10;
            }
            
            /* Selected state still needs to pop slightly */
            .selected-swap {
                transform: translate(-50%, -50%) scale(0.85) !important;
                z-index: 50 !important;
            }

            /* 6. Grid & Panels */
            .team-grid {
                grid-template-columns: repeat(2, 1fr); /* Force 2 columns */
                gap: 10px;
                padding: 10px;
                width: 95%;
            }
            
            .team-card {
                padding: 10px;
            }

            .panel-content {
                width: 90%;
                left: 5%;
                margin: 10px auto;
                max-height: 80vh;
                padding: 15px;
            }

            /* 7. Action Buttons at Bottom */
            .action-buttons {
                position: relative; /* Not fixed, flows with page */
                bottom: 0;
                right: 0;
                flex-direction: column;
                width: 90%;
                margin: 0 auto 30px auto;
            }

            .action-btn {
                width: 100%;
                padding: 15px;
                font-size: 1.1rem;
            }
        }

        /* --- NEW SWAP STYLES --- */
        .player-position, .reserve-card {
            cursor: pointer !important; /* Changed from move to pointer */
            transition: all 0.2s;
        }

        /* The visual effect when a player is "Selected" */
        .selected-swap {
            border: 3px solid #00ff00 !important;
            box-shadow: 0 0 20px #00ff00 !important;
            transform: translate(-50%, -50%) scale(1.15) !important; /* Pop effect */
            z-index: 1000 !important;
            background: #222 !important;
        }
        
        /* Reserve cards need slightly different transform since they aren't absolute positioned */
        .reserve-card.selected-swap {
            transform: scale(1.1) !important;
        }

        h1 { font-size: 4rem; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 5px; text-align: center; text-shadow: 0 5px 15px rgba(0,0,0,0.8); }
        h2 { font-size: 2rem; color: #d4af37; margin-bottom: 30px; }
        
        button {
            background: #d4af37;
            color: #1a1a1a;
            border: none;
            padding: 15px 40px;
            font-size: 1.5rem;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border-radius: 5px;
        }
        button:hover { transform: scale(1.05); box-shadow: 0 0 20px #d4af37; }

        input {
            padding: 15px;
            font-size: 1.5rem;
            text-align: center;
            border-radius: 5px;
            border: 2px solid #d4af37;
            background: #222;
            color: white;
            width: 300px;
            margin-bottom: 20px;
        }

        /* --- SCREENS --- */
        .screen { display: none; flex-direction: column; align-items: center; width: 100%; }
        .active { display: flex; }

        /* --- LEAGUE SELECTOR (The Pyramid) --- */
        .league-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            width: 80%;
        }

        .tier-row { display: flex; gap: 20px; justify-content: center; width: 100%; }

        .league-btn {
            background: #333;
            color: #eee;
            border: 1px solid #555;
            padding: 20px;
            width: 200px;
            font-size: 1.2rem;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }
        .league-btn:hover { background: #444; border-color: #d4af37; color: #d4af37; transform: translateY(-3px); }
        
        /* Tier Sizes */
        .tier-mls .league-btn { background: linear-gradient(45deg, #002D72, #0099D8); width: 400px; font-size: 1.8rem; border: none; }
        .tier-2 .league-btn { width: 300px; }
        .tier-3 .league-btn { width: 250px; }
        .tier-4 .league-btn { width: 220px; }
        .tier-5 .league-btn { width: 220px; }

        /* --- TEAM SELECTION SCREEN --- */
        .team-grid {
			display: grid;
			/* This tells the browser: "Make as many columns as fit, but none smaller than 160px" */
			grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
			gap: 15px;
			width: 90%;
			max-width: 1200px;
			max-height: 70vh; /* Limits height so buttons don't disappear */
			overflow-y: auto; /* Scroll teams vertically if there are many */
			padding: 20px;
		}

        .team-card {
            background: #2a2a2a;
            padding: 20px;
            border: 2px solid #444;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .team-card:hover {
            background: #333;
            border-color: #d4af37;
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.3);
        }
        
        .team-card.selected {
            background: #d4af37;
            color: #000;
            border-color: #d4af37;
        }
        
        .team-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .team-players {
            font-size: 0.9rem;
            color: #999;
        }
        
        .team-card.selected .team-players {
            color: #333;
        }

        /* --- MATCH DAY SCREEN --- */
        .matchday-container {
			display: flex;
			flex-direction: row; /* Desktop: Sidebar on left */
			width: 100vw;
			height: 100vh;
			overflow: hidden;
		}

        /* Left Sidebar Menu */
        .sidebar-menu {
			width: 250px;
			min-width: 250px;
			background: #1a1a1a;
			border-right: 3px solid #d4af37;
			display: flex;
			flex-direction: column;
			padding: 15px;
			gap: 10px;
			overflow-y: auto; /* Allows menu buttons to scroll if they don't fit */
		}

        .menu-btn {
            background: #2a2a2a;
            color: #d4af37;
            border: 2px solid #d4af37;
            padding: 15px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 5px;
        }

        .menu-btn:hover {
            background: #d4af37;
            color: #1a1a1a;
            transform: translateX(5px);
        }

        .menu-btn.active {
            background: #d4af37;
            color: #1a1a1a;
        }

        /* Main Tactical View */
        .tactical-view {
			flex: 1;
			display: flex;
			flex-direction: column;
			align-items: center;
			padding: 10px;
			overflow-y: auto; /* Allows the field AND buttons to be scrolled together */
			position: relative;
		}

        /* Soccer Field */
        .soccer-field {
            width: 600px;
            height: 900px;
            background: linear-gradient(to bottom, #2d5016 0%, #1a3d0a 50%, #2d5016 100%);
            border: 3px solid white;
            border-radius: 10px;
            position: relative;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }

        /* Field Lines */
        .field-line {
            position: absolute;
            background: rgba(255,255,255,0.3);
        }

        .halfway-line {
            width: 100%;
            height: 2px;
            top: 50%;
            left: 0;
        }

        .center-circle {
            width: 120px;
            height: 120px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .penalty-box-top {
            width: 300px;
            height: 100px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: none;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
        }

        .penalty-box-bottom {
            width: 300px;
            height: 100px;
            border: 2px solid rgba(255,255,255,0.3);
            border-bottom: none;
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Reserve Side Panel */
        .reserves-side-panel {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 470px;
            background: rgba(26, 26, 26, 0.98);
            border-right: 3px solid #d4af37;
            padding: 20px;
            z-index: 60;
            box-shadow: 5px 0 20px rgba(0, 0, 0, 0.5);
        }

        .reserves-list-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            overflow-y: auto;
            max-height: calc(100vh - 150px);
        }

        /* Reserve Cards */
        .reserve-card {
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #2a2a2a;
            border: 2px solid #555;
            border-radius: 8px;
            padding: 10px;
            cursor: move;
        }

        .reserve-card:hover {
            background: #333 !important;
            border-color: #d4af37 !important;
            transform: translateX(5px);
        }

        .reserve-card.dragging {
            opacity: 0.5;
        }

        /* Player Position Placeholders */
        .position-placeholder {
            position: absolute;
            width: 70px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translate(-50%, -50%);
            font-size: 10px;
            color: rgba(255, 255, 255, 0.4);
            text-align: center;
            pointer-events: none;
        }

        /* Player Positions */
        .player-position {
            position: absolute;
            width: 70px;
            height: 100px;
            background: #d4af37;
            border: 3px solid #fff;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            cursor: move;
            transition: all 0.2s;
            transform: translate(-50%, -50%);
            padding: 5px;
            z-index: 10;
        }

        .player-position:hover {
            background: #f0c040;
            transform: translate(-50%, -50%) scale(1.05);
            z-index: 20;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .player-position:active {
            cursor: grabbing;
        }

        .player-position.dragging {
            opacity: 0.7;
            z-index: 100;
        }

        .player-position.drop-target {
            background: #90EE90;
            transform: translate(-50%, -50%) scale(1.1);
        }

        .player-face-small {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #000;
            background: #fff;
            margin-bottom: 3px;
        }

        .player-rating {
            font-size: 16px;
            font-weight: bold;
            color: #000;
        }

        .player-name {
            font-size: 9px;
            color: #000;
            text-align: center;
            font-weight: bold;
            margin-top: 2px;
            line-height: 1.1;
        }

        .player-pos-tag {
            font-size: 8px;
            color: #555;
            font-weight: bold;
        }

        /* Action Buttons */
        .action-buttons {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            gap: 15px;
            z-index: 100;
        }

        .action-btn {
            background: #d4af37;
            color: #1a1a1a;
            border: none;
            padding: 20px 40px;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(212, 175, 55, 0.5);
            transition: all 0.3s;
        }

        .action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 40px rgba(212, 175, 55, 0.8);
        }

        .action-btn.secondary {
            background: #555;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
        }

        /* --- UPDATED PANEL OVERLAYS --- */
        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0; /* Changed from 250px to 0 for full-screen mobile support */
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000; /* Higher z-index to stay above sidebar */
            padding: 10px;
        }
		
		.panel-overlay.active {
            display: flex !important;
        }

        .panel-content {
            background: #1a1a1a;
            border: 3px solid #d4af37;
            border-radius: 10px;
            padding: 20px;
            width: 95%; /* Flexible width for mobile */
            max-width: 900px; /* Limits size on desktop */
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        /* Desktop Adjustment: If not mobile, shift overlay to the right of the sidebar */
        @media (min-width: 769px) {
            .panel-overlay {
                left: 250px;
            }
        }

        /* Reserve Panel Exception - No dark overlay! */
        #reserves-panel {
            background: none !important;
            align-items: flex-start !important;
            justify-content: flex-start !important;
            pointer-events: none;
        }

        #reserves-panel.active {
            display: block !important;
        }

        #reserves-panel .reserves-side-panel {
            pointer-events: all;
        }

        .panel-content {
            background: #1a1a1a;
            border: 3px solid #d4af37;
            border-radius: 10px;
            padding: 30px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close-panel {
            background: #d4af37;
            color: #000;
            border: none;
            padding: 10px 30px;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 5px;
            margin-top: 20px;
        }

        /* League Table */
        .league-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .league-table th,
        .league-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        .league-table th {
            background: #2a2a2a;
            color: #d4af37;
            font-weight: bold;
        }

        .league-table tr:hover {
            background: #2a2a2a;
        }

        .league-table .user-team {
            background: #d4af37;
            color: #000;
            font-weight: bold;
        }

        /* Match Result Display */
        .match-result {
            background: #2a2a2a;
            border: 3px solid #d4af37;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
        }

        .match-score {
            font-size: 4rem;
            color: #d4af37;
            font-weight: bold;
            margin: 20px 0;
        }

        .match-teams {
            font-size: 1.8rem;
            margin: 10px 0;
        }
		
		/* --- MUSIC NOTIFICATION --- */
        #music-notification {
            position: fixed;
            top: 20px;
            right: -350px; /* Hidden off-screen */
            background: rgba(0, 0, 0, 0.9);
            border-left: 5px solid #d4af37;
            padding: 15px 25px;
            color: white;
            z-index: 2000;
            transition: right 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-radius: 5px 0 0 5px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            font-family: 'Segoe UI', sans-serif;
            pointer-events: none; /* Let clicks pass through */
        }

        #music-notification.show {
            right: 0;
        }

        .music-icon {
            font-size: 24px;
            animation: pulse 1s infinite;
        }

        .music-text {
            display: flex;
            flex-direction: column;
        }

        .music-label {
            font-size: 10px;
            color: #d4af37;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .song-title {
            font-size: 14px;
            font-weight: bold;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
		
		/* --- MOBILE RESPONSIVE OVERRIDES --- */
		@media (max-width: 768px) {
			/* 1. Stack the Matchday Layout vertically */
			.matchday-container {
				flex-direction: column;
				overflow-y: auto; /* Allows scrolling the whole page */
			}

			/* 2. Turn Sidebar into a Top Scroll Bar */
			.sidebar-menu {
				width: 100%;
				height: auto;
				min-width: unset;
				border-right: none;
				border-bottom: 3px solid #d4af37;
				flex-direction: row;
				overflow-x: auto; /* Swipe menu buttons left/right */
				white-space: nowrap;
				padding: 10px;
				position: sticky;
				top: 0;
				z-index: 100;
			}

			.menu-btn {
				padding: 8px 15px;
				font-size: 0.9rem;
			}

			/* 3. Make the Field and Grid flexible */
			.soccer-field {
				width: 95vw;
				height: auto;
				aspect-ratio: 2 / 3;
				margin: 20px 0;
			}

			.team-grid {
				grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
				width: 100%;
				max-height: unset; /* Let it grow with content */
			}

			/* 4. Fix Panel/Transfer Window width */
			.panel-content {
				width: 95%;
				left: 2.5%;
				margin: 10px auto;
			}

			/* 5. Move Action Buttons to the bottom of the scroll */
			.action-buttons {
				position: relative;
				bottom: 0;
				right: 0;
				flex-direction: column;
				width: 90%;
				margin: 20px 0;
			}

			.action-btn {
				width: 100%;
				padding: 15px;
			}
		}
    </style>
</head>
<body>

	<div id="music-notification"><div class="music-icon">üéµ</div><div class="music-text"><span class="music-label">Now Playing</span><span class="song-title" id="notification-song-name">Song Name</span></div></div>
	
	<div id="manage-player-modal" class="panel-overlay" style="z-index: 3000;"></div>

    <div id="screen-start" class="screen active">
        <h1>American Soccer<br>Manager 2026</h1>
        <button onclick="goToName()">START GAME</button>
		<button onclick="loadGame()" style="margin-top:20px; background:#444; color:#fff; font-size:1rem;">Load Saved Game</button>
    </div>

    <div id="screen-name" class="screen">
        <h2>Who is taking charge?</h2>
        <input type="text" id="managerName" placeholder="Enter your name...">
        <button onclick="saveName()">Continue</button>
    </div>

    <div id="screen-leagues" class="screen">
        <h2 id="welcome-text">Select Your League</h2>
        
        <div class="league-container">
            <div class="tier-row tier-mls">
                <button class="league-btn" onclick="pickLeague('MLS')">Major League Soccer</button>
            </div>
            <div class="tier-row tier-2">
                <button class="league-btn" onclick="pickLeague('USL Championship')">USL Championship</button>
                <button class="league-btn" onclick="pickLeague('MLS Next Pro')">MLS Next Pro</button>
            </div>
            <div class="tier-row tier-3">
                <button class="league-btn" onclick="pickLeague('USL League One')">USL League One</button>
                <button class="league-btn" style="background:#222; color:#555; border-color:#444; cursor:not-allowed;" onclick="alert('Coming Soon!')">NISA</button>
            </div>
            <div class="tier-row tier-4">
                <button class="league-btn" style="background:#222; color:#555; border-color:#444; cursor:not-allowed;" onclick="alert('Coming Soon!')">USL League 2</button>
            </div>
            <div class="tier-row tier-5">
                <button class="league-btn" onclick="pickLeague('NPSL')">NPSL</button>
                <button class="league-btn" onclick="pickLeague('UPSL')">UPSL</button>
            </div>
            <div class="tier-row tier-5">
                <button class="league-btn" onclick="pickLeague('USASA')">USASA (Amateur)</button>
            </div>
        </div>
    </div>

    <div id="screen-teams" class="screen">
        <h2 id="teams-title">Select Your Team</h2>
        <div id="team-grid" class="team-grid"></div>
        <br>
        <button onclick="confirmTeam()">Confirm Team Selection</button>
        <button onclick="backToLeagues()" style="background: #555; margin-left: 10px;">Back</button>
    </div>

    <div id="screen-matchday" class="screen">
        <div class="matchday-container">
            <div class="sidebar-menu">
                <h2 style="color: #d4af37; font-size: 1.5rem; margin-bottom: 20px; text-align: center;">TEAM MENU</h2>
                <button class="menu-btn active" onclick="showStarting11()">Starting XI</button>
                <button class="menu-btn" onclick="showReserves()">Reserves</button>
                <button class="menu-btn" onclick="showSquadBudget()">Squad & Budget</button>
                <button class="menu-btn" onclick="showTraining()">Training</button>
                <button class="menu-btn" onclick="showFormations()">Formations</button>
                <button class="menu-btn" onclick="showLeagueTable()">League Table</button>
                <button class="menu-btn" onclick="showTrophyRoom()">üèÜ Trophy Room</button>
				
				
                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #d4af37;">
                    <div style="font-size: 0.9rem; color: #d4af37; margin-bottom: 10px;">
                        <strong>Match:</strong> <span id="current-match-num">1</span> of <span id="total-matches">0</span>
                    </div>
                    <div style="font-size: 0.9rem; color: #d4af37; margin-bottom: 10px;">
                        <strong>Points:</strong> <span id="team-points">0</span>
                    </div>
                    <div style="font-size: 0.9rem; color: #d4af37; margin-bottom: 10px;">
                        <strong>Budget:</strong> $<span id="team-budget">0</span>
                    </div>
                    <div style="font-size: 0.9rem; color: #d4af37;">
                        <strong>Spending:</strong> $<span id="team-spending">0</span>
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: #2a2a2a; border-radius: 5px; font-size: 0.8rem; color: #999;">
                    <strong style="color: #d4af37;">Expectations:</strong><br>
                    <span id="team-expectations">-</span>
                </div>
                <div style="margin-top: auto; padding-top: 20px;">
                    <button class="menu-btn" onclick="saveGame(true)" style="background:#444; color:#fff; border-color:#555; margin-top: 10px;">Save Game</button>
                    <button class="menu-btn" style="background: #8B0000; border-color: #8B0000; color: white;" onclick="returnToMenu()">Return to Menu</button>
                </div>
                
                <div class="scroll-hint">‚Ä∫</div> 
            </div> ```



            <div class="tactical-view">
                <h2 id="team-header" style="color: #d4af37; margin-bottom: 20px;">Your Team - Starting XI</h2>
                
                <div class="soccer-field">
                    <div class="field-line halfway-line"></div>
                    <div class="center-circle"></div>
                    <div class="penalty-box-top"></div>
                    <div class="penalty-box-bottom"></div>

                    <div id="field-players"></div>
                </div>

                <div class="action-buttons">
                    <button class="action-btn secondary" onclick="openTransferWindow()">Transfer Window</button>
                    <button class="action-btn secondary" onclick="viewSchedule()">View Schedule</button>
                    <button class="action-btn" id="match-action-btn" onclick="viewNextOpponent()">View Next Opponent</button>
                </div>
            </div>

            <div id="reserves-panel" class="panel-overlay">
                <div class="reserves-side-panel">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #d4af37;">
                        <h2 style="color: #d4af37; margin: 0;">Reserve Players</h2>
                        <button class="close-panel" onclick="closePanel('reserves-panel')" style="margin: 0;">Back</button>
                    </div>
                    <div id="reserves-list" style="display: flex; flex-direction: column; gap: 10px; overflow-y: auto; max-height: calc(100vh - 150px);"></div>
                </div>
            </div>

            <div id="formations-panel" class="panel-overlay">
                <div class="panel-content">
                    <h2 style="color: #d4af37;">Formations</h2>
                    <p>Formation selection coming soon...</p>
                    <button class="close-panel" onclick="closePanel('formations-panel')">Close</button>
                </div>
            </div>

            <div id="squad-budget-panel" class="panel-overlay">
                <div class="panel-content" style="max-width: 900px;">
                    <h2 style="color: #d4af37;">Squad & Budget Overview</h2>
                    <div id="squad-budget-display"></div>
                    <button class="close-panel" onclick="closePanel('squad-budget-panel')">Close</button>
                </div>
            </div>

            <div id="training-panel" class="panel-overlay">
                <div class="panel-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                    <h2 style="color: #d4af37;">Training & Tactics</h2>
                    <div id="training-display"></div>
                    <button class="close-panel" onclick="closePanel('training-panel')">Close</button>
                </div>
            </div>

            <div id="league-table-panel" class="panel-overlay">
                <div class="panel-content">
                    <h2 style="color: #d4af37;">League Standings</h2>
                    <div id="league-table-container"></div>
                    <button class="close-panel" onclick="closePanel('league-table-panel')">Close</button>
                </div>
            </div>

            <div id="trophy-room-panel" class="panel-overlay">
                <div class="panel-content" style="max-width: 900px;">
                    <h2 style="color: #d4af37;">üèÜ Trophy Room üèÜ</h2>
                    <div id="trophy-room-display"></div>
                    <button class="close-panel" onclick="closePanel('trophy-room-panel')">Close</button>
                </div>
            </div>

            <div id="match-result-panel" class="panel-overlay">
                <div class="panel-content">
                    <h2 style="color: #d4af37;">Match Result</h2>
                    <div id="match-result-display"></div>
                    <button class="close-panel" onclick="closeMatchResult()">Continue</button>
                </div>
            </div>

            <div id="transfer-window-panel" class="panel-overlay">
                <div class="panel-content">
                    <h2 style="color: #d4af37;">Transfer Window</h2>
                    <p>Transfer market coming soon...</p>
                    <p style="color: #999; font-size: 0.9rem;">Here you'll be able to buy and sell players, sign free agents, and manage contracts.</p>
                    <button class="close-panel" onclick="closePanel('transfer-window-panel')">Close</button>
                </div>
            </div>

            <div id="next-opponent-panel" class="panel-overlay">
                <div class="panel-content">
                    <h2 style="color: #d4af37;">Next Match</h2>
                    <div id="next-opponent-display"></div>
                    <br>
                    <button class="action-btn" onclick="simNextMatch()" style="padding: 15px 30px; font-size: 1.2rem;">SIM MATCH</button>
                    <button class="close-panel" onclick="closePanel('next-opponent-panel')">Back</button>
                </div>
            </div>

            <div id="schedule-panel" class="panel-overlay">
                <div class="panel-content" style="max-width: 1000px;">
                    <h2 style="color: #d4af37;">Season Schedule</h2>
                    <div id="schedule-display"></div>
                    <button class="close-panel" onclick="closePanel('schedule-panel')">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db = [];
        let playerAges = {}; // Store ages from multiple CSV sources
		let selectedSwapIndex = null; // Tracks which player is currently highlighted
        let managerName = "";
        let selectedLeague = "";
        let selectedTeam = "";
        let teamPlayers = [];
        let leagueTeams = [];
        let leagueStandings = [];
        let schedule = [];
        let openCupSchedule = [];
        let openCupActive = false;
        let openCupRound = "";
        let qualifiedForOpenCup = false;
        let currentMatchIndex = 0;
        let matchHalf = 0; 
        let firstHalfResult = null;
        let trainingIntensity = 1; 
        let trainedPlayers = []; 
        let playerStamina = {}; 
        let gameState = {
            season: 1,
            matchesPlayed: 0,
            budget: 0,
            budgetSpent: 0,
            prizesMoney: 0,
            openCupProgress: "",
            trainingIntensity: 1,
            playStyle: 'balanced', // 'aggressive', 'balanced', 'passive'
            trophies: {
                leagueTitles: 0,
                openCupWins: 0,
                cclWins: 0,
                cwcWins: 0,
                leagueHistory: [], // [{season: 1, league: 'MLS', position: 1}]
                cupHistory: []     // [{season: 1, competition: 'Open Cup', result: 'Winner'}]
            }
        };
        let starting11Initialized = false;
        let defaultStarting11Order = []; // Stores player indices for default starting XI

        // Helper function to calculate age from date of birth
        function calculateAge(dateOfBirth) {
            if (!dateOfBirth) return null;
            let birthDate = new Date(dateOfBirth);
            if (isNaN(birthDate)) return null;
            
            let today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            let monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age > 0 && age < 100 ? age : null;
        }
		
		// --- RESTORED: LOAD FREE AGENTS (Unfiltered) ---
        fetch('FreeAgents.csv')
            .then(res => res.text())
            .then(text => {
                let rows = text.split('\n');
                let loadedCount = 0;
                
                // We assume the CSV structure is: Name, Age, Position, BaseRating, DraftBonus
                // If your columns are different, swap the indices [0], [1], etc. below.
                
                rows.slice(1).forEach(row => {
                    let parts = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    
                    if(parts.length >= 3) {
                        let name = parts[0].replace(/"/g, '').trim();
                        let age = parseInt(parts[1]) || 21;
                        let pos = parts[2].replace(/"/g, '').trim();
                        
                        // 1. THE ONLY FILTER: Skip if Position is missing or null
                        if (!pos || pos === "" || pos.toLowerCase() === "null") return;

                        // 2. CALCULATE RATING (Base + Bonus)
                        let baseRating = parseInt(parts[3]) || 60; 
                        let draftBonus = parseInt(parts[4]) || 0; 
                        let finalRating = baseRating + draftBonus;

                        // 3. Add to Database
                        // We assign team: "Free Agent" internally so the game knows they are available
                        if(name) {
                            db.push({
                                name: name,
                                age: age,
                                position: pos,
                                rating: finalRating,
                                team: "Free Agent", 
                                league: "Free Agent",
                                faceId: "0",
                                hasImage: 0,
                                matchStamina: 100,
                                stats: { matches: 0, goals: 0, assists: 0 }
                            });
                            loadedCount++;
                        }
                    }
                });
                console.log(`‚úÖ Loaded ${loadedCount} players from FreeAgents.csv`);
            })
            .catch(err => console.log("‚ö†Ô∏è FreeAgents.csv not found or empty"));

		// --- NEW: LOAD CCL & CWC PLAYERS ---
        const loadTournamentData = (file, leagueTag) => {
            fetch(file)
                .then(r => r.text())
                .then(text => {
                    let rows = text.split('\n');
                    let count = 0;
                    rows.slice(1).forEach(row => {
                        let parts = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                        if (parts.length >= 7) {
                            let rawName = parts[0].replace(/"/g, '').trim();
                            let teamName = parts[3].replace(/"/g, '').trim();
                            // Only add if team doesn't exist in DB to avoid duplicates
                            if (!db.some(p => p.name === rawName && p.team === teamName)) {
                                db.push({
                                    name: rawName,
                                    rating: parseInt(parts[1]) || 65,
                                    league: leagueTag, // Tag for easy filtering
                                    team: teamName,
                                    faceId: parts[4] ? parts[4].replace(/"/g, '').trim() : "0",
                                    hasImage: parseInt(parts[5]) || 0,
                                    position: parts[6] ? parts[6].replace(/"/g, '').trim() : "MID",
                                    age: 25 // Default age
                                });
                                count++;
                            }
                        }
                    });
                    console.log(`‚úÖ Loaded ${count} players from ${file}`);
                })
                .catch(e => console.log(`‚ö†Ô∏è ${file} not found`));
        };

        loadTournamentData('CCL_Players.csv', 'CCL_Pool');
        loadTournamentData('CWC_Players.csv', 'CWC_Pool');
		
        // Load ages from player_profiles.csv (date_of_birth column)
        fetch('player_profiles.csv')
            .then(res => res.text())
            .then(text => {
                let rows = text.split('\n');
                let header = rows[0].split(',');
                let nameIdx = header.findIndex(h => h.toLowerCase().includes('name'));
                let dobIdx = header.findIndex(h => h.toLowerCase().includes('date_of_birth') || h.toLowerCase().includes('dob'));
                
                if (nameIdx !== -1 && dobIdx !== -1) {
                    rows.slice(1).forEach(row => {
                        let parts = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                        let name = parts[nameIdx] ? parts[nameIdx].replace(/"/g, '').trim() : '';
                        let dob = parts[dobIdx] ? parts[dobIdx].replace(/"/g, '').trim() : '';
                        
                        if (name && dob) {
                            let age = calculateAge(dob);
                            if (age) playerAges[name] = age;
                        }
                    });
                    console.log(`‚úÖ Loaded ${Object.keys(playerAges).length} ages from player_profiles.csv`);
                }
            })
            .catch(err => console.log('‚ö†Ô∏è  player_profiles.csv not found'));

        // Load ages from SemiPro_Amateur_teams.csv (Age column)
        fetch('SemiPro_Amateur_teams.csv')
            .then(res => res.text())
            .then(text => {
                let rows = text.split('\n');
                let header = rows[0].split(',');
                let nameIdx = header.findIndex(h => h.toLowerCase().includes('player') || (h.toLowerCase().includes('name') && !h.toLowerCase().includes('team')));
                let ageIdx = header.findIndex(h => h.toLowerCase() === 'age');
                
                if (nameIdx !== -1 && ageIdx !== -1) {
                    rows.slice(1).forEach(row => {
                        let parts = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                        let name = parts[nameIdx] ? parts[nameIdx].replace(/"/g, '').trim() : '';
                        let age = parseInt(parts[ageIdx]);
                        
                        if (name && age > 0 && age < 100) {
                            playerAges[name] = age;
                        }
                    });
                    console.log(`‚úÖ Total ages: ${Object.keys(playerAges).length} (including amateur players)`);
                }
            })
            .catch(err => console.log('‚ö†Ô∏è  SemiPro_Amateur_teams.csv not found'));

        // Load ages from CCL_Players.csv (Age column)
        fetch('CCL_Players.csv')
            .then(res => res.text())
            .then(text => {
                let rows = text.split('\n');
                let header = rows[0].split(',');
                let nameIdx = header.findIndex(h => h.toLowerCase().includes('player') || (h.toLowerCase().includes('name') && !h.toLowerCase().includes('team')));
                let ageIdx = header.findIndex(h => h.toLowerCase() === 'age');
                
                if (nameIdx !== -1 && ageIdx !== -1) {
                    rows.slice(1).forEach(row => {
                        let parts = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                        let name = parts[nameIdx] ? parts[nameIdx].replace(/"/g, '').trim() : '';
                        let age = parseInt(parts[ageIdx]);
                        
                        if (name && age > 0 && age < 100) {
                            playerAges[name] = age;
                        }
                    });
                    console.log(`‚úÖ Total ages: ${Object.keys(playerAges).length} (including CCL players)`);
                }
            })
            .catch(err => console.log('‚ö†Ô∏è  CCL_Players.csv not found'));

        // Load ages from CWC_Players.csv (Age column)
        fetch('CWC_Players.csv')
            .then(res => res.text())
            .then(text => {
                let rows = text.split('\n');
                let header = rows[0].split(',');
                let nameIdx = header.findIndex(h => h.toLowerCase().includes('player') || (h.toLowerCase().includes('name') && !h.toLowerCase().includes('team')));
                let ageIdx = header.findIndex(h => h.toLowerCase() === 'age');
                
                if (nameIdx !== -1 && ageIdx !== -1) {
                    rows.slice(1).forEach(row => {
                        let parts = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                        let name = parts[nameIdx] ? parts[nameIdx].replace(/"/g, '').trim() : '';
                        let age = parseInt(parts[ageIdx]);
                        
                        if (name && age > 0 && age < 100) {
                            playerAges[name] = age;
                        }
                    });
                    console.log(`‚úÖ Total ages: ${Object.keys(playerAges).length} (including CWC players)`);
                }
            })
            .catch(err => console.log('‚ö†Ô∏è  CWC_Players.csv not found'));
			
		// --- MISSING DATABASE LOADER (FINAL_GAME_DATA.csv) ---
        // This is the main file that actually creates the players in the game!
        // 1. Load Data
        fetch('FINAL_GAME_DATA.csv')
            .then(res => res.text())
            .then(text => {
                db = [];
                let rows = text.split('\n');
                rows.slice(1).forEach(row => {
                    let parts = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    if(parts.length >= 7) {
                        let rawName = parts[0].replace(/"/g, '').trim();
                        let rating = parseInt(parts[1]) || 50;
                        let league = parts[2] ? parts[2].replace(/"/g, '').trim() : "Unknown";
                        let teamName = parts[3].replace(/"/g, '').trim();
                        
                        // --- FILTER: REMOVE 2/II/NASL TEAMS ---
                        // This ensures they are not visible, playable, or opponents
                        let isReserveTeam = 
                            teamName.endsWith(' 2') ||
                            teamName.endsWith(' II') ||
                            teamName.endsWith(' B') ||
                            teamName.toLowerCase().includes('reserves') ||
                            teamName.toLowerCase().includes('academy') ||
                            teamName.toLowerCase().includes('u-23') ||
                            teamName.toLowerCase().includes('u23') ||
                            teamName.includes('(NASL)');
                        
                        // --- PLAYER OVERRIDE: MESSI ---
                        if (rawName.includes("Lionel Messi")) {
                            rating = 90;
                        }

                        // Only add to database if NOT a reserve team
                        if (!/^\d+$/.test(rawName) && rawName.length > 1 && !isReserveTeam) {
                            db.push({
                                name: rawName,
                                rating: rating, // Uses the updated 90 for Messi
                                league: league,
                                team: teamName,
                                faceId: parts[4] ? parts[4].replace(/"/g, '').trim() : "0",
                                hasImage: parseInt(parts[5]) || 0,
                                position: parts[6] ? parts[6].replace(/"/g, '').trim() : "Unknown",
                                age: playerAges[rawName] || 25 
                            });
                        }
                    }
                });
                
                // Remove duplicate players - keep the one in the highest league
                const leagueHierarchy = {
                    'MLS': 9,
                    'USL Championship': 8,
                    'MLS Next Pro': 7,
                    'USL League One': 6,
                    'NISA': 6,
                    'USL League 2': 5,
                    'NPSL': 4,
                    'UPSL': 4,
                    'USASA': 3
                };
                
                let playerMap = {};
                db.forEach(player => {
                    if (!playerMap[player.name]) {
                        playerMap[player.name] = player;
                    } else {
                        // Compare league levels
                        let existingLevel = leagueHierarchy[playerMap[player.name].league] || 0;
                        let newLevel = leagueHierarchy[player.league] || 0;
                        
                        // Keep the player in the higher league
                        if (newLevel > existingLevel) {
                            playerMap[player.name] = player;
                        }
                    }
                });
                
                // Replace db with deduplicated players
                db = Object.values(playerMap);
                
                console.log("‚úÖ Database Loaded:", db.length, "players (duplicates removed, reserve teams filtered)");
            });
			
		// --- DEVICE DETECTION ---
        // Checks if device supports touch or is a known mobile device
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || (navigator.maxTouchPoints > 0);
        let draggedCard = null;       // For Desktop Drag-and-Drop

        console.log("Device detected as Mobile?", isMobile);

        // --- NEW MLS DATA ---
        const MLS_EAST = [
            "Philadelphia Union", "FC Cincinnati", "Inter Miami CF", "Charlotte FC", "New York City FC", 
            "Nashville SC", "Columbus Crew", "Chicago Fire FC", "Orlando City SC", "New York Red Bulls", 
            "New England Revolution", "Toronto FC", "CF Montreal", "Atlanta United", "D.C. United"
        ];

        const MLS_WEST = [
            "San Diego FC", "Vancouver Whitecaps FC", "Los Angeles FC", "Minnesota United FC", "Seattle Sounders FC", 
            "Austin FC", "FC Dallas", "Portland Timbers", "Real Salt Lake", "San Jose Earthquakes", 
            "Colorado Rapids", "Houston Dynamo FC", "St. Louis CITY SC", "LA Galaxy", "Sporting Kansas City"
        ];

        // Open Cup Qualification Slots per League Tier
        const OPEN_CUP_SLOTS = {
            'USASA': 2,
            'NPSL': 5,
            'UPSL': 5,
            'USL League 2': 4,
            'NISA': 5,
            'USL League One': 5,
            'MLS Next Pro': 8,
            'USL Championship': 8,
            'MLS': 8
        };

        // When Open Cup starts (as percentage of season completed)
        const OPEN_CUP_START_TIMING = {
            'USASA': 0.45,      // 45% through season
            'NPSL': 0.48,
            'UPSL': 0.51,
            'USL League 2': 0.54,
            'NISA': 0.42,
            'USL League One': 0.39,
            'MLS Next Pro': 0.36,
            'USL Championship': 0.33,
            'MLS': 0.30         // 30% through season
        };

        // League Budget Rules
        const LEAGUE_RULES = {
            'USASA': {
                baseBudget: 0,
                perPlayerBudget: 0,
                maxRatingFree: 70,
                minAgeFree: 35,
                expectations: 'Win the league or qualify for Open Cup Round of 32'
            },
            'NPSL': {
                baseBudget: 0,
                perPlayerBudget: 225,
                maxRatingFree: 70,
                minAgeFree: 35,
                expectations: 'Win the league or qualify for Open Cup Round of 16'
            },
            'UPSL': {
                baseBudget: 0,
                perPlayerBudget: 225,
                maxRatingFree: 70,
                minAgeFree: 35,
                expectations: 'Win the league or qualify for Open Cup Round of 16'
            },
            'USL League 2': {
                baseBudget: 0,
                perPlayerBudget: 225,
                maxRatingFree: 70,
                minAgeFree: 35,
                expectations: 'Win the league or qualify for Open Cup Round of 16'
            },
            'NISA': {
                baseBudget: 80000,
                perPlayerBudget: 0,
                maxRatingFree: 0,
                minAgeFree: 0,
                expectations: 'Win the league or qualify for Open Cup Round of 8'
            },
            'USL League One': {
                baseBudget: 200000,
                perPlayerBudget: 0,
                maxRatingFree: 0,
                minAgeFree: 0,
                expectations: 'Win the league or qualify for Open Cup Round of 8'
            },
            'MLS Next Pro': {
                baseBudget: 200000,
                perPlayerBudget: 0,
                maxRatingFree: 0,
                minAgeFree: 0,
                expectations: 'Win the league'
            },
            'USL Championship': {
                baseBudget: 800000,
                perPlayerBudget: 0,
                maxRatingFree: 0,
                minAgeFree: 0,
                expectations: 'Win the league or qualify for Open Cup Quarterfinals'
            },
            'MLS': {
                baseBudget: 10000000,
                perPlayerBudget: 0,
                maxRatingFree: 0,
                minAgeFree: 0,
                expectations: 'Win the league, qualify for Open Cup Semifinals, or qualify for CCL'
            }
        };

        // Player Salary per Week based on Rating
        const PLAYER_SALARIES = {
            50: 250,
            55: 375,
            60: 800,
            65: 1250,
            70: 2000,
            75: 4000,
            80: 10000,
            85: 150000,
            90: 500000
        };

        // Prize Money
        const PRIZES = {
            'USASA_WINNER': 8000,
            'AMATEUR_OPEN_CUP_BEST': 50000,
            'OPEN_CUP_RUNNER_UP': 250000,
            'OPEN_CUP_WINNER': 600000
        };

        function getPlayerWeeklySalary(rating) {
            if (rating < 50) return 0; 
            if (rating >= 90) return PLAYER_SALARIES[90];
            if (rating >= 85) return PLAYER_SALARIES[85];
            if (rating >= 80) return PLAYER_SALARIES[80];
            if (rating >= 75) return PLAYER_SALARIES[75];
            if (rating >= 70) return PLAYER_SALARIES[70];
            if (rating >= 65) return PLAYER_SALARIES[65];
            if (rating >= 60) return PLAYER_SALARIES[60];
            if (rating >= 55) return PLAYER_SALARIES[55];
            return PLAYER_SALARIES[50];
        }

        function calculateSeasonBudget() {
            let rules = LEAGUE_RULES[selectedLeague];
            if (!rules) return 0;

            if (rules.perPlayerBudget > 0) {
                return rules.perPlayerBudget * teamPlayers.length;
            }
            return rules.baseBudget;
        }

        function checkOpenCupStart() {
            if (openCupActive) return false;
            
            let seasonProgress = currentMatchIndex / schedule.length;
            let startTiming = OPEN_CUP_START_TIMING[selectedLeague];
            
            if (seasonProgress >= startTiming) {
                startOpenCupPrelims();
                return true;
            }
            return false;
        }

        function startOpenCupPrelims() {
            console.log("Starting Open Cup Preliminary Rounds for " + selectedLeague);
            
            let sortedStandings = [...leagueStandings].sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                return b.goalDifference - a.goalDifference;
            });
            
            let slotsForLeague = OPEN_CUP_SLOTS[selectedLeague] || 2;
            let qualifyingTeams = sortedStandings.slice(0, slotsForLeague).map(s => s.team);
            
            if (qualifyingTeams.includes(selectedTeam)) {
                qualifiedForOpenCup = true;
                openCupActive = true;
                openCupRound = "Preliminary Round";
                
                generateOpenCupPrelims(qualifyingTeams);
                
                alert(`Congratulations! ${selectedTeam} has qualified for the US Open Cup!\nYou are in the ${openCupRound}.`);
            } else {
                alert(`${selectedTeam} did not qualify for the US Open Cup this year.\nTop ${slotsForLeague} teams qualified.`);
            }
        }

        function generateOpenCupPrelims(teams) {
            let shuffled = [...teams].sort(() => Math.random() - 0.5);
            
            for (let i = 0; i < shuffled.length; i += 2) {
                if (i + 1 < shuffled.length) {
                    openCupSchedule.push({
                        home: shuffled[i],
                        away: shuffled[i + 1],
                        round: openCupRound,
                        competition: "Open Cup"
                    });
                }
            }
            
            if (openCupSchedule.length > 0) {
                let userMatch = openCupSchedule.find(m => m.home === selectedTeam || m.away === selectedTeam);
                if (userMatch) {
                    schedule.splice(currentMatchIndex + 1, 0, userMatch);
                }
            }
        }

        // --- NEW: Open Cup Logic (Global Teams) ---
function generateRandomOpponent() {
    // 1. Get all unique teams from the database
    let allTeams = [...new Set(db.map(p => p.team))];
    
    // 2. Filter out teams from your current league
    let otherTeams = allTeams.filter(t => !leagueTeams.includes(t) && t !== selectedTeam && t !== "Free Agent");
    
    // 3. Fallback if something goes wrong
    if (otherTeams.length === 0) return "Unknown FC";
    
    return otherTeams[Math.floor(Math.random() * otherTeams.length)];
}

function insertNextOpenCupMatch() {
    let nextRound = "";
    if (openCupRound === "Preliminary Round") nextRound = "Round of 32";
    else if (openCupRound === "Round of 32") nextRound = "Round of 16";
    else if (openCupRound === "Round of 16") nextRound = "Quarterfinals";
    else if (openCupRound === "Quarterfinals") nextRound = "Semifinals";
    else if (openCupRound === "Semifinals") nextRound = "Final";
    
    if (nextRound) {
        openCupRound = nextRound;
        
        // FIX: Pick a random opponent from OUTSIDE the league
        let opponent = generateRandomOpponent();
        
        let nextMatch = {
            home: Math.random() < 0.5 ? selectedTeam : opponent,
            away: Math.random() < 0.5 ? opponent : selectedTeam,
            round: nextRound,
            competition: "Open Cup"
        };
        
        // Ensure user is playing
        if (nextMatch.home !== selectedTeam && nextMatch.away !== selectedTeam) {
            nextMatch.home = selectedTeam;
        }

        let insertPosition = currentMatchIndex + Math.floor(Math.random() * 3) + 3;
        if (insertPosition < schedule.length) {
            schedule.splice(insertPosition, 0, nextMatch);
        } else {
            schedule.push(nextMatch);
        }
        
        alert(`‚úÖ Advanced to the ${nextRound}! Next Opponent: ${opponent}`);
    }
}

        // Add variable for USASA signing cap
		let usasaSigningsCount = 0;

		function calculateCurrentSpending() {
			// Define Amateurs
			const AMATEUR_LEAGUES = ['USASA', 'NPSL', 'UPSL', 'USL League 2'];
			if (AMATEUR_LEAGUES.includes(selectedLeague)) {
				return 0; // Amateurs pay $0 wages
			}

			let weeklyTotal = 0;
			teamPlayers.forEach(player => {
				weeklyTotal += getPlayerWeeklySalary(player.rating);
			});
			return weeklyTotal * 34;
		}

        function goToName() {
            document.getElementById('screen-start').classList.remove('active');
            document.getElementById('screen-name').classList.add('active');
			initMusicSystem();
        }

        function saveName() {
            let input = document.getElementById('managerName').value;
            if(input.length < 1) return alert("Please enter a name!");
            managerName = input;
            document.getElementById('welcome-text').innerText = `Welcome, Manager ${managerName}. Select a League:`;
            document.getElementById('screen-name').classList.remove('active');
            document.getElementById('screen-leagues').classList.add('active');
        }

        function pickLeague(searchKey) {
            selectedLeague = searchKey;
            
            let leaguePlayers = db.filter(p => {
                let leagueInCSV = p.league.trim();
                
                if (searchKey === 'MLS') {
                    return leagueInCSV === 'MLS';
                }

                let L = leagueInCSV.toLowerCase();
                let S = searchKey.toLowerCase();
                
                if (S.includes('championship')) return L.includes('championship');
                if (S.includes('league one')) return L.includes('league one') || L.includes('usl1');
                if (S.includes('league 2')) return L.includes('league 2') || L.includes('usl2');
                if (S.includes('next pro')) return L.includes('next pro');
                if (S === 'usasa') return L.includes('usasa') || (!L.includes('upsl') && !L.includes('npsl') && !L.includes('mls') && !L.includes('usl') && !L.includes('nisa'));
                
                return L.includes(S.toLowerCase());
            });

            if(leaguePlayers.length > 0) {
                showTeamSelection(leaguePlayers);
            } else {
                alert(`No players found for "${searchKey}".`);
            }
        }

        function showTeamSelection(players) {
            let teams = {};
            players.forEach(p => {
                if(!teams[p.team]) {
                    teams[p.team] = [];
                }
                teams[p.team].push(p);
            });

            // --- FILTER: Only show teams with 11 or more players ---
            leagueTeams = Object.keys(teams)
                .filter(t => teams[t].length >= 11)
                .sort();
            
            document.getElementById('teams-title').innerText = `${selectedLeague} - Select Your Team`;
            
            let grid = document.getElementById('team-grid');
            grid.innerHTML = '';
            
            leagueTeams.forEach(teamName => {
                let card = document.createElement('div');
                card.className = 'team-card';
                card.onclick = () => selectTeam(teamName, card, teams[teamName]);
                card.innerHTML = `
                    <div class="team-name">${teamName}</div>
                    <div class="team-players">${teams[teamName].length} Players</div>
                `;
                grid.appendChild(card);
            });

            document.getElementById('screen-leagues').classList.remove('active');
            document.getElementById('screen-teams').classList.add('active');
        }

        function selectTeam(teamName, cardElement, players) {
            document.querySelectorAll('.team-card').forEach(c => c.classList.remove('selected'));
            
            cardElement.classList.add('selected');
            selectedTeam = teamName;
            teamPlayers = players;
        }

        function confirmTeam() {
            if(!selectedTeam) {
                return alert("Please select a team first!");
            }

            teamPlayers.sort((a, b) => b.rating - a.rating);
            
            // Initialize player stats
            teamPlayers.forEach(player => {
                if (!player.stats) {
                    player.stats = {
                        goals: 0,
                        assists: 0,
                        appearances: 0,
                        yellowCards: 0,
                        redCards: 0,
                        suspended: false,
                        yellowCardRisk: false
                    };
                }
            });

            initializeSeason();
            
            gameState.budget = calculateSeasonBudget();
            gameState.budgetSpent = calculateCurrentSpending();
            gameState.prizesMoney = 0;

            document.getElementById('screen-teams').classList.remove('active');
            document.getElementById('screen-matchday').classList.add('active');
            
            document.getElementById('team-header').innerText = `${selectedTeam} - Starting XI`;
            
            displayStarting11();
            updateMatchInfo();
            updateStaminaDisplay();
        }

        function backToLeagues() {
            document.getElementById('screen-teams').classList.remove('active');
            document.getElementById('screen-leagues').classList.add('active');
        }
		
		// --- TOURNAMENT VARIABLES ---
        let pendingQualifiers = { ccl: [], cwc: [] }; // Stores qualifiers for next season
        let seasonQualifiers = { shield: null, cupWinner: null, cupRunnerUp: null };

        // --- 1. MLS PLAYOFF LOGIC ---
        function startMLSPlayoffs() {
            alert("End of Regular Season!\nTop 4 teams from East and West advance to Playoffs.");
            
            // 1. Identify Supporters Shield Winner (Best Record)
            let sortedOverall = [...leagueStandings].sort((a, b) => b.points - a.points || b.goalDifference - a.goalDifference);
            seasonQualifiers.shield = sortedOverall[0].team;
            alert(`üõ°Ô∏è SUPPORTERS' SHIELD WINNER: ${seasonQualifiers.shield}`);

            // 2. Split into Conferences
            let eastTable = leagueStandings.filter(t => MLS_EAST.includes(t.team)).sort((a,b) => b.points - a.points);
            let westTable = leagueStandings.filter(t => MLS_WEST.includes(t.team)).sort((a,b) => b.points - a.points);

            let eastQual = eastTable.slice(0, 4).map(t => t.team);
            let westQual = westTable.slice(0, 4).map(t => t.team);

            if (!eastQual.includes(selectedTeam) && !westQual.includes(selectedTeam)) {
                alert("You did not qualify for the playoffs.");
                determineNextSeasonQualifiers(null); // Sim winner
                checkSeasonEnd(false); // End season standard way
                return;
            }

            // 3. Generate Playoff Schedule (Simple Bracket)
            // Quarters -> Semis -> Final
            let playoffMatches = [];
            
            // Function to pick opponent (if user is seed 1, play seed 4)
            // Simplified: User plays standard bracket, others randomized result
            let myConf = eastQual.includes(selectedTeam) ? eastQual : westQual;
            let oppConf = eastQual.includes(selectedTeam) ? westQual : eastQual;
            let mySeed = myConf.indexOf(selectedTeam);
            
            // Conference Semis
            let myOpponent = myConf[3 - mySeed]; // 1v4 or 2v3
            playoffMatches.push({ home: selectedTeam, away: myOpponent, competition: "MLS Playoffs", round: "Conf. Semis" });
            
            // Inject into schedule
            schedule.push(...playoffMatches);
            alert(`Playoff Match Scheduled: vs ${myOpponent}`);
        }

        // --- 2. HANDLE PLAYOFF PROGRESSION ---
        function handlePlayoffResult(match, result) {
            let winner = result.homeGoals > result.awayGoals ? match.home : match.away;
            if (result.homeGoals === result.awayGoals) winner = Math.random() < 0.5 ? match.home : match.away; // Penalties

            if (winner !== selectedTeam) {
                alert(`‚ùå Eliminated from Playoffs by ${winner}.`);
                determineNextSeasonQualifiers(winner); // Winner goes on to win cup in sim
                return;
            }

            if (match.round === "Conf. Semis") {
                // Advance to Conf Finals
                let nextOpp = "Conf Rival FC"; // Simplified sim
                schedule.push({ home: selectedTeam, away: nextOpp, competition: "MLS Playoffs", round: "Conf. Finals" });
            } else if (match.round === "Conf. Finals") {
                // Advance to MLS Cup
                let eastChamp = MLS_EAST.includes(selectedTeam) ? selectedTeam : "East Champ FC";
                let westChamp = MLS_WEST.includes(selectedTeam) ? selectedTeam : "West Champ FC";
                let opp = eastChamp === selectedTeam ? westChamp : eastChamp;
                schedule.push({ home: selectedTeam, away: opp, competition: "MLS Playoffs", round: "MLS Cup Final" });
            } else if (match.round === "MLS Cup Final") {
                // WON MLS CUP
                seasonQualifiers.cupWinner = selectedTeam;
                seasonQualifiers.cupRunnerUp = match.home === selectedTeam ? match.away : match.home;
                gameState.trophies.leagueTitles++; // Count as major title
                alert("üèÜüèÜüèÜ MLS CUP CHAMPIONS! üèÜüèÜüèÜ");
                determineNextSeasonQualifiers(selectedTeam);
            }
        }

        // --- 3. DETERMINE QUALIFIERS (User's Logic) ---
        function determineNextSeasonQualifiers(simulatedCupWinner) {
            // If user didn't win, use simulated winner
            let cupWinner = seasonQualifiers.cupWinner || simulatedCupWinner || seasonQualifiers.shield;
            let shieldWinner = seasonQualifiers.shield;
            let runnerUp = seasonQualifiers.cupRunnerUp || "Runner Up FC"; // Simplified if not tracked

            // CCL QUALIFICATION LOGIC
            // 1. Open Cup Winner (tracked in gameState.trophies or we assume sim)
            // 2. MLS Winner
            // 3. Shield Winner
            // 4. Runner Up
            let cclQuals = [cupWinner, shieldWinner, runnerUp]; 
            
            // Logic: "If MLS Cup Winner == Shield Winner, then Div Winner opposite"
            if (cupWinner === shieldWinner) {
                let shieldConf = MLS_EAST.includes(shieldWinner) ? 'East' : 'West';
                let oppDivWinner = shieldConf === 'East' ? MLS_WEST[0] : MLS_EAST[0]; // Assuming array order is standings
                cclQuals.push(oppDivWinner);
            }
            
            // Save for next season if User is in the list
            if (cclQuals.includes(selectedTeam) || qualifiedForOpenCup) { // Open cup check handled separately
                pendingQualifiers.ccl.push(selectedTeam);
            }

            // CWC QUALIFICATION LOGIC
            // "MLS Winner and CCL Winner"
            // We don't know next season's CCL winner yet, but we check if WE won MLS Cup
            if (cupWinner === selectedTeam) {
                pendingQualifiers.cwc.push(selectedTeam);
            }
            
            // Logic: "If MLS winner is CCL winner -> Shield Winner"
            // This logic actually runs AT THE END of next season or start of CWC.
            // For now, we flag eligibility.
        }

        // --- 4. GENERATE CCL SCHEDULE ---
        function generateCCLGroup() {
            if (!pendingQualifiers.ccl.includes(selectedTeam)) return;
            
            alert("üåé You have qualified for the CONCACAF Champions League!");
            
            // Get 3 random opponents from CCL_Pool
            let pool = db.filter(p => p.league === 'CCL_Pool').map(p => p.team);
            let uniqueTeams = [...new Set(pool)];
            let group = [];
            for(let i=0; i<3; i++) group.push(uniqueTeams[Math.floor(Math.random()*uniqueTeams.length)] || "Liga MX Club");
            
            // Add 6 matches (Home/Away) to schedule
            // Insert them early in the season (indices 2, 4, 6, 8, 10, 12)
            group.forEach((opp, i) => {
                schedule.splice(2 + (i*2), 0, { home: selectedTeam, away: opp, competition: "CCL Group", round: "Group Stage" });
                schedule.splice(3 + (i*2), 0, { home: opp, away: selectedTeam, competition: "CCL Group", round: "Group Stage" });
            });
        }

        // --- 5. GENERATE CWC SCHEDULE ---
        function generateCWC() {
            // Check complex logic: MLS Winner & CCL Winner
            // Simplified: If user won MLS Cup OR CCL last season
            let qualified = pendingQualifiers.cwc.includes(selectedTeam) || gameState.trophies.cclWins > 0;
            
            if (!qualified) return;

            alert("üåçüèÜ You have qualified for the CLUB WORLD CUP!");
            
            // Get opponents
            let pool = db.filter(p => p.league === 'CWC_Pool').map(p => p.team);
            let uniqueTeams = [...new Set(pool)];
            
            // CWC is usually knockout or small group. Let's do a group of 3 (2 matches)
            let opp1 = uniqueTeams[Math.floor(Math.random()*uniqueTeams.length)] || "Real Madrid";
            let opp2 = uniqueTeams[Math.floor(Math.random()*uniqueTeams.length)] || "Flamengo";
            
            // Add to END of schedule
            schedule.push({ home: selectedTeam, away: opp1, competition: "Club World Cup", round: "Group Stage" });
            schedule.push({ home: selectedTeam, away: opp2, competition: "Club World Cup", round: "Group Stage" });
        }

        // --- NEW: Player Stats Tracking ---
		function initializeSeason() {
            leagueStandings = leagueTeams.map(team => ({
                team: team,
                played: 0, won: 0, drawn: 0, lost: 0,
                goalsFor: 0, goalsAgainst: 0, goalDifference: 0, points: 0
            }));

            // Reset season specific trackers
            seasonQualifiers = { shield: null, cupWinner: null, cupRunnerUp: null };
            
            teamPlayers.forEach(p => {
                p.stats = { matches: 0, goals: 0, assists: 0, cleanSheets: 0 };
            });

            schedule = generateSchedule(leagueTeams);
            
            // --- INSERT NEW TOURNAMENTS ---
            generateCCLGroup(); // Checks pendingQualifiers inside
            generateCWC();      // Checks pendingQualifiers inside
            
            // Reset pending for the cycle after this
            // (Optional: Keep them if you want history, but clear to avoid duplicate generation)
            pendingQualifiers = { ccl: [], cwc: [] }; 

            currentMatchIndex = 0;
            gameState.matchesPlayed = 0;
            document.getElementById('total-matches').innerText = schedule.length;
        }

// --- NEW: Player Info Modal ---
function showPlayerInfo(e, playerName) {
    if(e) e.stopPropagation(); // Stop it from triggering a swap
    
    let player = teamPlayers.find(p => p.name === playerName);
    if(!player) return;
    
    // Initialize stats if missing
    if(!player.stats) player.stats = { matches: 0, goals: 0, assists: 0 };

    let infoHtml = `
        <div id="player-info-modal" class="panel-overlay active" style="z-index: 3000;">
            <div class="panel-content" style="max-width: 400px; text-align: center;">
                <h2 style="color: #d4af37;">${player.name}</h2>
                <div style="font-size: 1.2rem; color: #ccc; margin-bottom: 20px;">
                    ${player.position} | Rating: <span style="color: #d4af37; font-weight: bold;">${player.rating}</span> | Age: ${player.age || 25}
                </div>
                
                <div style="background: #222; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 10px;">Season Stats</h3>
                    <div style="display: flex; justify-content: space-around; margin-top: 15px;">
                        <div>
                            <div style="font-size: 1.5rem; font-weight: bold;">${player.stats.matches}</div>
                            <div style="font-size: 0.8rem; color: #999;">Matches</div>
                        </div>
                        <div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #4CAF50;">${player.stats.goals}</div>
                            <div style="font-size: 0.8rem; color: #999;">Goals</div>
                        </div>
                        <div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #2196F3;">${player.stats.assists}</div>
                            <div style="font-size: 0.8rem; color: #999;">Assists</div>
                        </div>
                    </div>
                </div>

                <div style="background: #222; padding: 15px; border-radius: 10px;">
                    <h3 style="margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 10px;">Contract</h3>
                    <div style="margin-top: 10px;">Weekly Wage: $${getPlayerWeeklySalary(player.rating).toLocaleString()}</div>
                    <div style="margin-top: 5px;">Value: $${(getPlayerWeeklySalary(player.rating) * 50).toLocaleString()}</div>
                </div>

                <button class="close-panel" onclick="document.getElementById('player-info-modal').remove()">Close</button>
            </div>
        </div>
    `;
    
    let tempDiv = document.createElement('div');
    tempDiv.innerHTML = infoHtml;
    document.body.appendChild(tempDiv.firstElementChild);
}

        function generateSchedule(teams) {
            let schedule = [];
            
            // MLS SPECIFIC SCHEDULE LOGIC
            if (selectedLeague === 'MLS') {
                let myConf = MLS_EAST.includes(selectedTeam) ? MLS_EAST : MLS_WEST;
                let otherConf = MLS_EAST.includes(selectedTeam) ? MLS_WEST : MLS_EAST;
                
                // 1. Play everyone in your conference TWICE (Home & Away)
                let confOpponents = myConf.filter(t => t !== selectedTeam);
                
                confOpponents.forEach(opp => {
                    schedule.push({ home: selectedTeam, away: opp, competition: "League" });
                    schedule.push({ home: opp, away: selectedTeam, competition: "League" });
                });
                
                // 2. Play 6 random teams from the other conference (3 Home, 3 Away)
                let otherShuffled = [...otherConf].sort(() => Math.random() - 0.5);
                let crossOpponents = otherShuffled.slice(0, 6);
                
                crossOpponents.forEach((opp, index) => {
                    if (index < 3) {
                        schedule.push({ home: selectedTeam, away: opp, competition: "League" });
                    } else {
                        schedule.push({ home: opp, away: selectedTeam, competition: "League" });
                    }
                });
                
            } else {
                // STANDARD LOGIC for other leagues
                let numTeams = teams.length;
                let rounds = numTeams < 8 ? 2 : 1; 

                for (let round = 0; round < rounds; round++) {
                    for (let i = 0; i < numTeams; i++) {
                        for (let j = i + 1; j < numTeams; j++) {
                            if (teams[i] === selectedTeam || teams[j] === selectedTeam) {
                                if (round === 0) schedule.push({ home: teams[i], away: teams[j], competition: "League" });
                                else schedule.push({ home: teams[j], away: teams[i], competition: "League" });
                            }
                        }
                    }
                }
            }

            return shuffle(schedule);
        }

        function shuffle(array) {
            let shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function saveDefaultStarting11() {
            // Save the current order of starting 11 as the default
            defaultStarting11Order = teamPlayers.slice(0, 11).map(p => p.name);
        }
        
        function restoreDefaultStarting11() {
            // Restore the starting 11 to the saved default order
            if (defaultStarting11Order.length === 0) return;
            
            let newOrder = [];
            let remaining = [...teamPlayers];
            
            // First, add players in the default order
            defaultStarting11Order.forEach(name => {
                let index = remaining.findIndex(p => p.name === name);
                if (index !== -1) {
                    newOrder.push(remaining[index]);
                    remaining.splice(index, 1);
                }
            });
            
            // If some default players are missing (sold/released), fill with best available
            while (newOrder.length < 11 && remaining.length > 0) {
                remaining.sort((a, b) => b.rating - a.rating);
                newOrder.push(remaining.shift());
            }
            
            // Add remaining players as reserves
            teamPlayers = [...newOrder, ...remaining];
        }

        function displayStarting11() {
            let fieldContainer = document.getElementById('field-players');
            fieldContainer.innerHTML = '';

            if (!starting11Initialized) {
                let newOrder = selectStarting11();
                let reserves = teamPlayers.filter(p => !newOrder.includes(p));
                teamPlayers = [...newOrder, ...reserves];
                starting11Initialized = true;
                // Save default starting XI order (just the indices 0-10)
                saveDefaultStarting11();
            }

            let starting11 = teamPlayers.slice(0, 11);

            const formationSlots = [
                { x: 50, y: 92, label: 'GK', role: 'GK' },
                { x: 15, y: 72, label: 'LB', role: 'DEF' },
                { x: 38, y: 75, label: 'CB', role: 'DEF' },
                { x: 62, y: 75, label: 'CB', role: 'DEF' },
                { x: 85, y: 72, label: 'RB', role: 'DEF' },
                { x: 30, y: 50, label: 'CM', role: 'MID' },
                { x: 50, y: 55, label: 'CDM', role: 'MID' },
                { x: 70, y: 50, label: 'CM', role: 'MID' },
                { x: 15, y: 22, label: 'LW', role: 'ATT' },
                { x: 50, y: 18, label: 'ST', role: 'ATT' },
                { x: 85, y: 22, label: 'RW', role: 'ATT' }
            ];

            formationSlots.forEach((slot, index) => {
                let placeholder = document.createElement('div');
                placeholder.className = 'position-placeholder';
                placeholder.style.left = slot.x + '%';
                placeholder.style.top = slot.y + '%';
                placeholder.dataset.slotIndex = index;
                placeholder.innerHTML = slot.label;
                fieldContainer.appendChild(placeholder);
            });

            starting11.forEach((player, index) => {
                if (index >= formationSlots.length) return;
                
                let slot = formationSlots[index];
                createPlayerCard(player, slot.x, slot.y, index, fieldContainer);
            });
        }

        function selectStarting11() {
            let selected = [];
            let remaining = [...teamPlayers];

            function findAndTake(positions, fallbackPositions = []) {
                for (let pos of positions) {
                    let index = remaining.findIndex(p => p.position === pos);
                    if (index !== -1) {
                        let player = remaining.splice(index, 1)[0];
                        return player;
                    }
                }
                for (let pos of fallbackPositions) {
                    let index = remaining.findIndex(p => p.position === pos);
                    if (index !== -1) {
                        let player = remaining.splice(index, 1)[0];
                        return player;
                    }
                }
                if (remaining.length > 0) {
                    remaining.sort((a, b) => b.rating - a.rating);
                    return remaining.shift();
                }
                return null;
            }

            let gk = findAndTake(['GK']);
            if (gk) selected.push(gk);

            let cb1 = findAndTake(['CB'], ['LB', 'RB']);
            if (cb1) selected.push(cb1);
            let cb2 = findAndTake(['CB'], ['LB', 'RB']);
            if (cb2) selected.push(cb2);

            let lb = findAndTake(['LB'], ['CB', 'LM']);
            if (lb) selected.push(lb);
            let rb = findAndTake(['RB'], ['CB', 'RM']);
            if (rb) selected.push(rb);

            let cm1 = findAndTake(['CM', 'CDM'], ['CAM', 'LM', 'RM']);
            if (cm1) selected.push(cm1);
            let cdm = findAndTake(['CDM', 'CM'], ['CB']);
            if (cdm) selected.push(cdm);
            let cm2 = findAndTake(['CM', 'CAM'], ['CDM', 'LM', 'RM']);
            if (cm2) selected.push(cm2);

            let lw = findAndTake(['LW', 'LM'], ['CF', 'ST']);
            if (lw) selected.push(lw);
            let st = findAndTake(['ST', 'CF'], ['CAM', 'LW', 'RW']);
            if (st) selected.push(st);
            let rw = findAndTake(['RW', 'RM'], ['CF', 'ST']);
            if (rw) selected.push(rw);

            while (selected.length < 11 && remaining.length > 0) {
                remaining.sort((a, b) => b.rating - a.rating);
                selected.push(remaining.shift());
            }

            return selected;
        }
		
		// --- HELPER: GET STAMINA COLOR ---
		function getStaminaColor(value) {
			if(value > 80) return '#4CAF50'; // Green
			if(value > 50) return '#FFEB3B'; // Yellow
			return '#F44336'; // Red
		}

        function createPlayerCard(player, x, y, slotIndex, container) {
            let playerDiv = document.createElement('div');
            playerDiv.className = 'player-position';
            playerDiv.style.left = x + '%';
            playerDiv.style.top = y + '%';
            
            playerDiv.dataset.slotIndex = slotIndex;
            playerDiv.dataset.playerIndex = teamPlayers.indexOf(player);
            
            // Calculate position penalty
            const formationPositions = ['GK', 'LB', 'CB', 'CB', 'RB', 'CM', 'CDM', 'CM', 'LW', 'ST', 'RW'];
            let slotPosition = formationPositions[slotIndex];
            let penalty = getPositionPenalty(player.position, slotPosition);
            let effectiveRating = Math.max(player.rating + penalty, 1);
            
            // --- STAMINA LOGIC ---
            // If match hasn't started, use Training Max. If it has, use current match stamina.
            let currentStamina = player.matchStamina !== undefined ? player.matchStamina : getTrainingStaminaCap();
            
            // Color Coding
            let staminaColor = '#4CAF50'; // Green
            if(currentStamina < 70) staminaColor = '#ff4444'; // Red
            else if(currentStamina < 85) staminaColor = '#FFEB3B'; // Yellow

            let imgSrc = 'downloaded_faces/0.png';
            if (player.hasImage === 1 && player.faceId && player.faceId !== '0') {
                imgSrc = `downloaded_faces/${player.faceId}.png`;
            }
            
            let cleanName = player.name.replace(/\(\d+\)/g, '').trim();
            
            // Display effective rating with penalty indicator
            let ratingDisplay = penalty < 0 ? `${effectiveRating}<span style="color:#ff4444; font-size:12px;">(${penalty})</span>` : player.rating;
            let cardBorder = penalty < -2 ? '2px solid #ff4444' : penalty < 0 ? '2px solid #ff9800' : '';
            
            playerDiv.style.border = cardBorder;
            
            // Suspension/Card indicators
            let suspensionIndicator = '';
            if (player.stats && player.stats.suspended) {
                suspensionIndicator = '<div style="position:absolute; top:-12px; left:-12px; font-size:26px; z-index:10; filter: drop-shadow(0 0 3px black);" title="Suspended - Cannot Play">üü•</div>';
            } else if (player.stats && player.stats.yellowCardRisk) {
                suspensionIndicator = '<div style="position:absolute; top:-12px; left:-12px; font-size:26px; z-index:10; filter: drop-shadow(0 0 3px black);" title="Yellow Card Risk (4 cards)">üü®</div>';
            }
            
            // ADDED: Stamina Bubble in top right
            playerDiv.innerHTML = `
                ${suspensionIndicator}
                <div style="position:absolute; top:-5px; right:-5px; background:${staminaColor}; color:#000; border-radius:50%; width:22px; height:22px; font-size:10px; font-weight:bold; display:flex; align-items:center; justify-content:center; border:1px solid #fff; z-index:5;">
                    ${Math.round(currentStamina)}
                </div>
                <img src="${imgSrc}" class="player-face-small" onerror="this.src='downloaded_faces/0.png'">
                <div class="player-rating">${ratingDisplay}</div>
                <div class="player-pos-tag">${player.position}</div>
                <div class="player-name">${cleanName}</div>
            `;
            
            playerDiv.onclick = function(e) { handleSwapClick(this, e); };
            
            // Desktop Drag events
            playerDiv.draggable = true;
            playerDiv.addEventListener('dragstart', handleDragStart);
            playerDiv.addEventListener('dragend', handleDragEnd);
            playerDiv.addEventListener('dragover', handleDragOver);
            playerDiv.addEventListener('drop', handleCardDrop);
            playerDiv.addEventListener('dragenter', handleDragEnter);
            playerDiv.addEventListener('dragleave', handleDragLeave);

            if (selectedSwapIndex === parseInt(playerDiv.dataset.playerIndex)) {
                playerDiv.classList.add('selected-swap');
            }
            
            container.appendChild(playerDiv);
        }

        function handleDragStart(e) {
            draggedCard = e.currentTarget;
            draggedCard.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', draggedCard.innerHTML);
        }

        function handleDragEnd(e) {
            if (draggedCard) {
                draggedCard.classList.remove('dragging');
                document.querySelectorAll('.player-position').forEach(card => {
                    card.classList.remove('drop-target');
                });
                draggedCard = null;
            }
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (e.currentTarget !== draggedCard && e.currentTarget.classList.contains('player-position')) {
                e.currentTarget.classList.add('drop-target');
            }
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drop-target');
        }

        function handleCardDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            e.preventDefault();

            let dropTarget = e.currentTarget;
            
            if (draggedCard && dropTarget !== draggedCard && dropTarget.classList.contains('player-position')) {
                
                if (draggedCard.dataset.fromReserves === 'true') {
                    let reservePlayerIndex = parseInt(draggedCard.dataset.playerIndex);
                    let startingPlayerIndex = parseInt(dropTarget.dataset.playerIndex);
                    
                    let temp = teamPlayers[reservePlayerIndex];
                    teamPlayers[reservePlayerIndex] = teamPlayers[startingPlayerIndex];
                    teamPlayers[startingPlayerIndex] = temp;
                    
                    displayStarting11();
                    updateStaminaDisplay();
                    
                    if (document.getElementById('reserves-panel').classList.contains('active')) {
                        showReserves();
                    }
                    
                } else {
                    let draggedPlayerIndex = parseInt(draggedCard.dataset.playerIndex);
                    let targetPlayerIndex = parseInt(dropTarget.dataset.playerIndex);
                    
                    let temp = teamPlayers[draggedPlayerIndex];
                    teamPlayers[draggedPlayerIndex] = teamPlayers[targetPlayerIndex];
                    teamPlayers[targetPlayerIndex] = temp;
                    
                    displayStarting11();
                }
                
                dropTarget.classList.remove('drop-target');
            }
            
            return false;
        }

        function showStarting11() {
            // 1. Reset UI Selection Variables (Fixes "stuck" green borders)
            selectedSwapIndex = null; 
            draggedCard = null;

            // 2. Switch the active tab visual
            setActiveMenuBtn(0);
            
            // 3. Close all open windows (Transfers, Reserves, etc.)
            document.querySelectorAll('.panel-overlay').forEach(p => p.classList.remove('active'));

            // 4. THE FIX: Force the game to re-calculate and re-draw the field positions
            // This fixes the "squished" bug by resetting the layout from scratch
            displayStarting11(); 
            
            // 5. Scroll back to the top (Helpful on mobile)
            let view = document.querySelector('.tactical-view');
            if (view) view.scrollTop = 0;
        }
        
        function showReserves() {
    setActiveMenuBtn(1);
    closeAllPanels();
    
    let panelId = 'reserves-panel';
    let panel = document.getElementById(panelId);
    if (!panel) {
        panel = document.createElement('div');
        panel.id = panelId;
        panel.className = 'panel-overlay';
        document.body.appendChild(panel);
    }

    let html = `
        <div class="panel-content" style="display: flex; flex-direction: column; height: 85vh; padding: 0; pointer-events: auto;">
            <div style="flex: 0 0 auto; padding: 15px; border-bottom: 2px solid #d4af37; background: #222;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="color: #d4af37; margin: 0; font-size: 1.2rem;">Reserves (<span id="reserves-count">${teamPlayers.length - 11}</span>)</h2>
                    <button class="close-panel" onclick="closePanel('${panelId}')" style="margin: 0; padding: 8px 15px; font-size: 0.9rem;">Back</button>
                </div>
                
                <!-- Search and Filter -->
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <input type="text" id="reserve-search" placeholder="Search player name..." 
                           style="flex: 1; min-width: 150px; padding: 8px; background: #333; border: 1px solid #555; color: #fff; border-radius: 5px;"
                           oninput="filterReserves()">
                    <select id="position-filter" onchange="filterReserves()" 
                            style="padding: 8px; background: #333; border: 1px solid #555; color: #fff; border-radius: 5px; cursor: pointer;">
                        <option value="">All Positions</option>
                        <option value="GK">GK</option>
                        <option value="DEF">Defenders</option>
                        <option value="MID">Midfielders</option>
                        <option value="ATT">Attackers</option>
                        <option value="CB">CB</option>
                        <option value="LB">LB</option>
                        <option value="RB">RB</option>
                        <option value="CM">CM</option>
                        <option value="CDM">CDM</option>
                        <option value="CAM">CAM</option>
                        <option value="LW">LW</option>
                        <option value="RW">RW</option>
                        <option value="ST">ST</option>
                        <option value="CF">CF</option>
                    </select>
                </div>
            </div>
            <div id="reserves-list" class="reserves-list-grid"></div>
        </div>
    `;
    
    panel.innerHTML = html;
    panel.classList.add('active');

    // Initial display
    filterReserves();
}

function filterReserves() {
    let searchTerm = document.getElementById('reserve-search')?.value.toLowerCase() || '';
    let positionFilter = document.getElementById('position-filter')?.value || '';
    
    let reserves = teamPlayers.slice(11);
    
    // Apply filters
    let filtered = reserves.filter((player, index) => {
        let nameMatch = player.name.toLowerCase().includes(searchTerm);
        
        let positionMatch = true;
        if (positionFilter) {
            if (positionFilter === 'DEF') {
                positionMatch = ['CB', 'LB', 'RB', 'LWB', 'RWB'].includes(player.position);
            } else if (positionFilter === 'MID') {
                positionMatch = ['CM', 'CDM', 'CAM', 'LM', 'RM'].includes(player.position);
            } else if (positionFilter === 'ATT') {
                positionMatch = ['LW', 'RW', 'ST', 'CF'].includes(player.position);
            } else {
                positionMatch = player.position === positionFilter;
            }
        }
        
        return nameMatch && positionMatch;
    });
    
    // Update count
    let countEl = document.getElementById('reserves-count');
    if (countEl) countEl.textContent = filtered.length;
    
    // Display filtered reserves
    let list = document.getElementById('reserves-list');
    if (!list) return;
    
    list.innerHTML = '';
    
    if (filtered.length === 0) {
        list.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">No players match your search</div>';
        return;
    }
    
    filtered.forEach((player) => {
        let playerIndex = teamPlayers.indexOf(player);
        
        // Get stamina
        let currentStamina = player.matchStamina !== undefined ? player.matchStamina : 100;
        
        // Color coding
        let staminaColor = '#4CAF50'; // Green
        if(currentStamina < 70) staminaColor = '#ff4444'; // Red
        else if(currentStamina < 85) staminaColor = '#FFEB3B'; // Yellow
        
        let imgSrc = 'downloaded_faces/0.png';
        if (player.hasImage === 1 && player.faceId && player.faceId !== '0') {
            imgSrc = `downloaded_faces/${player.faceId}.png`;
        }
        
        let cleanName = player.name.replace(/\(\d+\)/g, '').trim();
        
        // Suspension/Card indicators
        let suspensionIndicator = '';
        if (player.stats && player.stats.suspended) {
            suspensionIndicator = '<div style="position:absolute; top:-12px; left:-12px; font-size:26px; z-index:10; filter: drop-shadow(0 0 3px black);" title="Suspended - Cannot Play">üü•</div>';
        } else if (player.stats && player.stats.yellowCardRisk) {
            suspensionIndicator = '<div style="position:absolute; top:-12px; left:-12px; font-size:26px; z-index:10; filter: drop-shadow(0 0 3px black);" title="Yellow Card Risk (4 cards)">üü®</div>';
        }
        
        let card = document.createElement('div');
        card.className = 'reserve-card';
        card.dataset.playerIndex = playerIndex;
        
        card.innerHTML = `
            ${suspensionIndicator}
            <div style="position:absolute; top:-5px; right:-5px; background:${staminaColor}; color:#000; border-radius:50%; width:22px; height:22px; font-size:10px; font-weight:bold; display:flex; align-items:center; justify-content:center; border:1px solid #fff; z-index:5;">
                ${Math.round(currentStamina)}
            </div>
            <img src="${imgSrc}" class="player-face-small" onerror="this.src='downloaded_faces/0.png'">
            <div class="player-rating">${player.rating}</div>
            <div class="player-pos-tag">${player.position}</div>
            <div class="player-name">${cleanName}</div>
        `;
        
        card.onclick = function(e) { handleSwapClick(this, e); };
        card.draggable = true;
        card.dataset.fromReserves = 'true';
        card.addEventListener('dragstart', handleReserveDragStart);
        card.addEventListener('dragend', handleDragEnd);

        if (selectedSwapIndex === parseInt(card.dataset.playerIndex)) {
            card.classList.add('selected-swap');
        }
        
        list.appendChild(card);
    });
}

        function showSquadBudget() {
            closeAllPanels();
            // Define active tab
            setActiveMenuBtn(2);

            const AMATEUR_LEAGUES = ['USASA', 'NPSL', 'UPSL', 'USL League 2'];
            let isUserAmateur = AMATEUR_LEAGUES.includes(selectedLeague);

            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #d4af37; margin: 0;">Squad & Budget</h2>
                    <button class="close-panel" onclick="closePanel('squad-budget-panel')" style="margin: 0; padding: 5px 20px; font-size: 0.9rem;">Back</button>
                </div>

                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-around; padding: 15px; background: #2a2a2a; border-radius: 10px;">
                        <div style="text-align: center;">
                            <div style="font-size: 0.8rem; color: #999;">Budget</div>
                            <div style="font-size: 1.5rem; color: #d4af37;">$${gameState.budget.toLocaleString()}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.8rem; color: #999;">Spent</div>
                            <div style="font-size: 1.5rem; color: ${gameState.budgetSpent > gameState.budget ? '#ff4444' : '#4CAF50'};">$${gameState.budgetSpent.toLocaleString()}</div>
                        </div>
                    </div>
                </div>

                <div style="text-align:center; color:#888; font-size:0.8rem; margin-bottom:10px;">
                    Tip: Click a player to Sell, Release, or Retire them.
                </div>

                <table class="league-table">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>Age</th>
                            <th>Pos</th>
                            <th>Rat</th>
                            <th>Goals</th>
                            <th>Ast</th>
                            <th>üü®</th>
                            <th>üü•</th>
                            <th>Wage/Wk</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            teamPlayers.forEach((player, index) => {
                let cleanName = player.name.replace(/\(\d+\)/g, '').trim();
                let weeklySalary = getPlayerWeeklySalary(player.rating);
                if (isUserAmateur) weeklySalary = 0;

                // Added onclick to the row
                html += `
                    <tr onclick="openPlayerManageModal(${index})" style="cursor: pointer; transition: background 0.2s;">
                        <td><strong>${cleanName}</strong></td>
                        <td>${player.age || 25}</td>
                        <td>${player.position}</td>
                        <td>${player.rating}</td>
                        <td>${player.stats?.goals || 0}</td>
                        <td>${player.stats?.assists || 0}</td>
                        <td>${player.stats?.yellowCards || 0}</td>
                        <td>${player.stats?.redCards || 0}</td>
                        <td>${weeklySalary === 0 ? 'Amateur' : '$' + weeklySalary.toLocaleString()}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>
                <div style="margin-top: 15px; font-size: 0.85rem; color: #999; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                    <p style="margin: 5px 0;"><strong style="color: #d4af37;">Discipline:</strong> 5 yellow cards = 1 match suspension. Red card = immediate suspension.</p>
                    <p style="margin: 5px 0;">${isUserAmateur ? "Amateur players do not receive wages." : "Wages are paid weekly for a 34-week season."}</p>
                </div>
            `;

            document.getElementById('squad-budget-display').innerHTML = html;
            document.getElementById('squad-budget-panel').classList.add('active');
        }

        function showTraining() {
            setActiveMenuBtn(3);
            closeAllPanels();
            
            let trainingHTML = `
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #d4af37; margin: 0;">Select Training Intensity</h3>
                        <button class="close-panel" onclick="closePanel('training-panel')" style="margin: 0; padding: 5px 20px; font-size: 0.9rem;">Back</button>
                    </div>
                    
                    <p style="color: #ccc; margin-bottom: 30px;">Training affects player development and match stamina. Only 15 players can train per week.</p>
                    
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div class="training-option ${trainingIntensity === 1 ? 'selected' : ''}" onclick="setTrainingIntensity(1)" style="background: ${trainingIntensity === 1 ? '#d4af37' : '#2a2a2a'}; color: ${trainingIntensity === 1 ? '#000' : '#fff'}; padding: 20px; border-radius: 10px; cursor: pointer; border: 2px solid #d4af37;">
                            <h4 style="margin: 0 0 10px 0;">1x Per Week (Light)</h4>
                            <ul style="margin: 0; padding-left: 20px;">
                                <li>+1 rating improvement per season</li>
                                <li>100% stamina for matches</li>
                                <li>Best for maintaining fitness</li>
                            </ul>
                        </div>
                        
                        <div class="training-option ${trainingIntensity === 2 ? 'selected' : ''}" onclick="setTrainingIntensity(2)" style="background: ${trainingIntensity === 2 ? '#d4af37' : '#2a2a2a'}; color: ${trainingIntensity === 2 ? '#000' : '#fff'}; padding: 20px; border-radius: 10px; cursor: pointer; border: 2px solid #d4af37;">
                            <h4 style="margin: 0 0 10px 0;">2x Per Week (Moderate)</h4>
                            <ul style="margin: 0; padding-left: 20px;">
                                <li>+2 rating improvement per season</li>
                                <li>85% stamina for matches</li>
                                <li>Balanced approach</li>
                            </ul>
                        </div>
                        
                        <div class="training-option ${trainingIntensity === 3 ? 'selected' : ''}" onclick="setTrainingIntensity(3)" style="background: ${trainingIntensity === 3 ? '#d4af37' : '#2a2a2a'}; color: ${trainingIntensity === 3 ? '#000' : '#fff'}; padding: 20px; border-radius: 10px; cursor: pointer; border: 2px solid #d4af37;">
                            <h4 style="margin: 0 0 10px 0;">3x Per Week (Intense)</h4>
                            <ul style="margin: 0; padding-left: 20px;">
                                <li>+2 rating improvement per season</li>
                                <li>50% chance: Half of starting XI gets +1 extra</li>
                                <li>75% stamina for matches</li>
                                <li>Risk vs. reward strategy</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Play Style Section -->
                    <div style="border-top: 3px solid #d4af37; margin-top: 40px; padding-top: 30px;">
                        <h3 style="color: #d4af37; margin-bottom: 15px;">‚öΩ Play Style & Tactics</h3>
                        <p style="color: #ccc; margin-bottom: 20px;">Choose your team's playing style. Affects possession and discipline in matches.</p>
                        
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div onclick="setPlayStyle('aggressive')" style="background: ${gameState.playStyle === 'aggressive' ? '#d4af37' : '#2a2a2a'}; color: ${gameState.playStyle === 'aggressive' ? '#000' : '#fff'}; padding: 20px; border-radius: 10px; cursor: pointer; border: 2px solid ${gameState.playStyle === 'aggressive' ? '#d4af37' : '#555'};">
                            <h4 style="margin: 0 0 10px 0;">‚öîÔ∏è Aggressive ${gameState.playStyle === 'aggressive' ? '‚úì SELECTED' : ''}</h4>
                            <ul style="margin: 0; padding-left: 20px;">
                                <li>+15% possession</li>
                                <li>30% chance of yellow card per half</li>
                                <li>5% chance of red card per half</li>
                                <li>High-pressure football</li>
                            </ul>
                        </div>
                        
                        <div onclick="setPlayStyle('balanced')" style="background: ${gameState.playStyle === 'balanced' ? '#d4af37' : '#2a2a2a'}; color: ${gameState.playStyle === 'balanced' ? '#000' : '#fff'}; padding: 20px; border-radius: 10px; cursor: pointer; border: 2px solid ${gameState.playStyle === 'balanced' ? '#d4af37' : '#555'};">
                            <h4 style="margin: 0 0 10px 0;">‚öñÔ∏è Balanced ${gameState.playStyle === 'balanced' ? '‚úì SELECTED' : ''}</h4>
                            <ul style="margin: 0; padding-left: 20px;">
                                <li>Normal possession</li>
                                <li>15% chance of yellow card per half</li>
                                <li>2% chance of red card per half</li>
                                <li>Well-rounded approach</li>
                            </ul>
                        </div>
                        
                        <div onclick="setPlayStyle('passive')" style="background: ${gameState.playStyle === 'passive' ? '#d4af37' : '#2a2a2a'}; color: ${gameState.playStyle === 'passive' ? '#000' : '#fff'}; padding: 20px; border-radius: 10px; cursor: pointer; border: 2px solid ${gameState.playStyle === 'passive' ? '#d4af37' : '#555'};">
                            <h4 style="margin: 0 0 10px 0;">üõ°Ô∏è Passive ${gameState.playStyle === 'passive' ? '‚úì SELECTED' : ''}</h4>
                            <ul style="margin: 0; padding-left: 20px;">
                                <li>-15% possession</li>
                                <li>5% chance of yellow card per half</li>
                                <li>0.5% chance of red card per half</li>
                                <li>Defensive, disciplined style</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('training-display').innerHTML = trainingHTML;
            document.getElementById('training-panel').classList.add('active');
        }

        function setTrainingIntensity(intensity) {
            trainingIntensity = intensity;
            gameState.trainingIntensity = intensity;
            showTraining(); 
            updateStaminaDisplay();
        }
        
        function setPlayStyle(style) {
            gameState.playStyle = style;
            showTraining(); // Refresh to show selection
        }

        function handleReserveDragStart(e) {
            draggedCard = e.currentTarget;
            draggedCard.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', draggedCard.innerHTML);
        }

        function showFormations() {
            setActiveMenuBtn(4);
            closeAllPanels();
            document.getElementById('formations-panel').classList.add('active');
        }

        function showLeagueTable() {
            setActiveMenuBtn(5);
            closeAllPanels();
            
            let sortedStandings = [...leagueStandings].sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (b.goalDifference !== a.goalDifference) return b.goalDifference - a.goalDifference;
                return b.goalsFor - a.goalsFor;
            });

            let tableHTML = `
                <table class="league-table">
                    <thead>
                        <tr>
                            <th>Pos</th>
                            <th>Team</th>
                            <th>P</th>
                            <th>W</th>
                            <th>D</th>
                            <th>L</th>
                            <th>GF</th>
                            <th>GA</th>
                            <th>GD</th>
                            <th>Pts</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedStandings.forEach((team, index) => {
                let rowClass = team.team === selectedTeam ? 'user-team' : '';
                tableHTML += `
                    <tr class="${rowClass}">
                        <td>${index + 1}</td>
                        <td>${team.team}</td>
                        <td>${team.played}</td>
                        <td>${team.won}</td>
                        <td>${team.drawn}</td>
                        <td>${team.lost}</td>
                        <td>${team.goalsFor}</td>
                        <td>${team.goalsAgainst}</td>
                        <td>${team.goalDifference > 0 ? '+' : ''}${team.goalDifference}</td>
                        <td><strong>${team.points}</strong></td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            document.getElementById('league-table-container').innerHTML = tableHTML;
            document.getElementById('league-table-panel').classList.add('active');
        }

        function showTrophyRoom() {
            setActiveMenuBtn(6);
            closeAllPanels();
            
            let trophyHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="display: flex; justify-content: space-around; margin-bottom: 40px;">
                        <div style="padding: 20px; background: #2a2a2a; border-radius: 10px; min-width: 150px;">
                            <div style="font-size: 3rem;">üèÜ</div>
                            <div style="font-size: 2rem; color: #d4af37; margin: 10px 0;">${gameState.trophies.leagueTitles}</div>
                            <div style="font-size: 0.9rem; color: #999;">League Titles</div>
                        </div>
                        <div style="padding: 20px; background: #2a2a2a; border-radius: 10px; min-width: 150px;">
                            <div style="font-size: 3rem;">üèÜ</div>
                            <div style="font-size: 2rem; color: #d4af37; margin: 10px 0;">${gameState.trophies.openCupWins}</div>
                            <div style="font-size: 0.9rem; color: #999;">Open Cup Wins</div>
                        </div>
                        <div style="padding: 20px; background: #2a2a2a; border-radius: 10px; min-width: 150px;">
                            <div style="font-size: 3rem;">üåé</div>
                            <div style="font-size: 2rem; color: #d4af37; margin: 10px 0;">${gameState.trophies.cclWins || 0}</div>
                            <div style="font-size: 0.9rem; color: #999;">CCL Wins</div>
                        </div>
                    </div>
            `;
            
            // League History
            if (gameState.trophies.leagueHistory.length > 0) {
                trophyHTML += `
                    <h3 style="color: #d4af37; margin-top: 30px;">League History</h3>
                    <table class="league-table" style="margin-top: 15px;">
                        <thead>
                            <tr>
                                <th>Season</th>
                                <th>League</th>
                                <th>Position</th>
                                <th>Points</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                gameState.trophies.leagueHistory.forEach(record => {
                    let trophy = record.position === 1 ? 'üèÜ ' : '';
                    trophyHTML += `
                        <tr class="${record.position === 1 ? 'user-team' : ''}">
                            <td>${record.season}</td>
                            <td>${record.league}</td>
                            <td>${trophy}${record.position}</td>
                            <td>${record.points}</td>
                        </tr>
                    `;
                });
                
                trophyHTML += '</tbody></table>';
            }
            
            // Cup History
            if (gameState.trophies.cupHistory.length > 0) {
                trophyHTML += `
                    <h3 style="color: #d4af37; margin-top: 30px;">Cup History</h3>
                    <table class="league-table" style="margin-top: 15px;">
                        <thead>
                            <tr>
                                <th>Season</th>
                                <th>Competition</th>
                                <th>Round</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                gameState.trophies.cupHistory.forEach(record => {
                    let trophy = record.result === 'Winner' ? 'üèÜ ' : '';
                    trophyHTML += `
                        <tr class="${record.result === 'Winner' ? 'user-team' : ''}">
                            <td>${record.season}</td>
                            <td>${record.competition}</td>
                            <td>${record.round}</td>
                            <td>${trophy}${record.result}</td>
                        </tr>
                    `;
                });
                
                trophyHTML += '</tbody></table>';
            }
            
            if (gameState.trophies.leagueHistory.length === 0 && gameState.trophies.cupHistory.length === 0) {
                trophyHTML += `
                    <p style="color: #999; margin-top: 30px;">No trophies yet. Win competitions to add to your trophy cabinet!</p>
                `;
            }
            
            trophyHTML += '</div>';
            
            document.getElementById('trophy-room-display').innerHTML = trophyHTML;
            document.getElementById('trophy-room-panel').classList.add('active');
        }

        function setActiveMenuBtn(index) {
            document.querySelectorAll('.menu-btn').forEach((btn, i) => {
                if(i === index) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function closePanel(panelId) {
            document.getElementById(panelId).classList.remove('active');
        }

        function closeAllPanels() {
            document.querySelectorAll('.panel-overlay').forEach(p => p.classList.remove('active'));
        }

        function openTransferWindow() {
            closeAllPanels();
            
            // Removed fixed 900px width
            let html = `
                <div class="panel-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #d4af37; margin: 0; font-size: 1.5rem;">Transfer Market</h2>
                        <div style="font-size: 1rem; color: #4CAF50;">Budget: $${(gameState.budget - gameState.budgetSpent).toLocaleString()}</div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 20px;">
                        <button onclick="loadTransferList('free')" class="menu-btn" style="flex: 1; padding: 10px; font-size: 0.9rem;">Free Agents</button>
                        <button onclick="showSearchFilters()" class="menu-btn" style="flex: 1; padding: 10px; font-size: 0.9rem;">Search</button>
                    </div>

                    <div id="transfer-filters" style="display: none; background: #222; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                        <input type="text" id="search-name" placeholder="Name..." style="width: 100%; font-size: 1rem; padding: 10px; margin-bottom: 10px; box-sizing: border-box;">
                        <select id="search-position" style="width: 100%; padding: 10px; background: #333; color: white; border: 1px solid #555;">
                            <option value="">Any Position</option>
                            <option value="GK">GK</option>
                            <option value="DEF">DEF</option>
                            <option value="MID">MID</option>
                            <option value="ATT">ATT</option>
                        </select>
                        <button onclick="loadTransferList('search')" style="width: 100%; margin-top: 10px; padding: 10px; background: #d4af37; border: none; font-weight: bold;">SEARCH</button>
                    </div>

                    <div id="transfer-results" style="height: 350px; overflow-y: auto; border: 1px solid #333; background: #1a1a1a;">
                        <div style="padding: 20px; text-align: center; color: #666;">Use filters to load players.</div>
                    </div>

                    <button class="close-panel" onclick="closePanel('transfer-window-panel')">Close</button>
                </div>
            `;

            let panel = document.getElementById('transfer-window-panel');
            panel.innerHTML = html;
            panel.classList.add('active');
        }

        function showSearchFilters() {
            document.getElementById('transfer-filters').style.display = 'block';
            document.getElementById('transfer-results').innerHTML = '';
        }

        // --- TRANSFER VARIABLES ---
        let currentFreeAgentIndex = 0;
        let freeAgentsLoaded = false; 

        // 1. MAIN LOADER (Restored Exact CSV Logic)
        function loadTransferList(type = 'free', append = false) {
            let container = document.getElementById('transfer-results');
            
            if (!append) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#d4af37;">Scanning Market...</div>';
                if (type === 'free') currentFreeAgentIndex = 0;
            }

            // MODE A: FREE AGENTS
            if (type === 'free') {
                if (!freeAgentsLoaded) {
                    fetch('FreeAgents.csv')
                        .then(r => r.text())
                        .then(text => {
                            let rows = text.split('\n');
                            
                            // Start loop at 1 to skip header
                            for (let i = 1; i < rows.length; i++) {
                                let cols = rows[i].split(',');
                                if (cols.length < 6) continue; 

                                // EXACT PARSING LOGIC FROM YOUR FILE
                                let draftPick = parseInt(cols[0]) || 100;
                                let name = cols[2] ? cols[2].trim() : "Unknown";
                                let pos = cols[5] ? cols[5].trim() : "";
                                let mp = parseInt(cols[6]) || 0;
                                let goals = parseInt(cols[8]) || 0;
                                let ast = parseInt(cols[9]) || 0;

                                if (!pos) continue;

                                // Rating Calculation
                                let baseRating = 69 - (draftPick * 0.15);
                                let statsBonus = (mp * 0.2) + (goals * 1.5) + (ast * 1.0);
                                let finalRating = Math.round(baseRating + statsBonus);
                                
                                if (finalRating > 75) finalRating = 75;
                                if (finalRating < 50) finalRating = 50;

                                db.push({
                                    name: name,
                                    rating: finalRating,
                                    league: "Free Agent", 
                                    team: "Free Agent",
                                    position: pos, 
                                    faceId: "0",   
                                    hasImage: 0,
                                    matchStamina: 100,
                                    stats: { matches: 0, goals: 0, assists: 0 }
                                });
                            }
                            
                            freeAgentsLoaded = true;
                            renderFreeAgents(container, append);
                        })
                        .catch(err => {
                            console.error(err);
                            container.innerHTML = '<div style="padding:20px; text-align:center;">Error loading FreeAgents.csv</div>';
                        });
                } else {
                    renderFreeAgents(container, append);
                }
                return;
            }

            // MODE B: SEARCH
            if (type === 'search') {
                let nameQuery = document.getElementById('search-name').value.toLowerCase();
                let posQuery = document.getElementById('search-position').value;
                
                let results = db.filter(p => {
                    let matchName = nameQuery ? p.name.toLowerCase().includes(nameQuery) : true;
                    let matchPos = posQuery ? p.position.includes(posQuery) : true;
                    return matchName && matchPos && p.team !== selectedTeam && !teamPlayers.includes(p);
                });
                
                renderList(container, results.slice(0, 50), false, false);
            }
        }

        // 2. HELPER: FILTER & PAGE FREE AGENTS
        function renderFreeAgents(container, append) {
            let allFreeAgents = db.filter(p => 
                (p.team === "Free Agent" || p.league === "Free Agent") && 
                p.team !== selectedTeam
            );
            
            let results = allFreeAgents.slice(currentFreeAgentIndex, currentFreeAgentIndex + 20);
            currentFreeAgentIndex += 20;
            let hasMore = currentFreeAgentIndex < allFreeAgents.length;

            if (!append && results.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center;">No free agents found.</div>';
                return;
            }

            renderList(container, results, append, hasMore);
        }

        // 3. HELPER: BUILD TABLE (With Amateur Display)
        function renderList(container, results, append, hasMore) {
            let rows = '';
            
            // Check League Type
            const AMATEUR_LEAGUES = ['USASA', 'NPSL', 'UPSL', 'USL League 2'];
            let isUserAmateur = AMATEUR_LEAGUES.includes(selectedLeague);

            if (!append) {
                container.innerHTML = '<table class="league-table" id="transfer-table"><thead><tr><th>Name</th><th>Pos</th><th>Rat</th><th>Cost/Wage</th><th>Action</th></tr></thead><tbody id="transfer-table-body"></tbody></table>';
            }

            results.forEach(p => {
                let wage = getPlayerWeeklySalary(p.rating);
                let isAmateurSigning = isUserAmateur && p.rating <= 60;
                let costDisplay = "";
                
                if (isAmateurSigning) {
                    costDisplay = `<span style="color:#4CAF50">Amateur</span> (Free)`;
                } else if (p.team === "Free Agent") {
                    costDisplay = `<span style="color:#4CAF50">Free Tfr</span> ($${wage.toLocaleString()}/wk)`;
                } else {
                    costDisplay = `$${(wage * 50).toLocaleString()} (Fee) + Wage`;
                }
                
                rows += `
                    <tr>
                        <td>${p.name}</td>
                        <td>${p.position}</td>
                        <td style="font-weight:bold; color: #d4af37;">${p.rating}</td>
                        <td style="font-size: 0.8rem;">${costDisplay}</td>
                        <td><button onclick="signPlayer('${p.name}', this)" style="padding: 5px 15px; font-size: 0.8rem; background: #d4af37; border: none; color: #000; font-weight: bold; cursor: pointer; border-radius: 3px;">SIGN</button></td>
                    </tr>
                `;
            });

            let tbody = document.getElementById('transfer-table-body');
            if (tbody) tbody.insertAdjacentHTML('beforeend', rows);

            // Handle "Load More" button
            let oldBtn = document.getElementById('load-more-container');
            if(oldBtn) oldBtn.remove();

            if (hasMore) {
                container.insertAdjacentHTML('beforeend', `
                    <div id="load-more-container" style="text-align: center; padding: 20px;">
                        <button onclick="loadTransferList('free', true)" style="background: #333; color: #fff; border: 1px solid #555; padding: 10px 30px; cursor: pointer; border-radius: 5px;">Load More Players</button>
                    </div>
                `);
            }
        }

        // 4. SIGN PLAYER (Fixed Budget Math)
        function signPlayer(playerName, btn) {
            let p = db.find(x => x.name === playerName);
            if(!p) return alert("Error: Player not found.");

            // CHECK LEAGUE RULES
            const AMATEUR_LEAGUES = ['USASA', 'NPSL', 'UPSL', 'USL League 2'];
            let isUserAmateur = AMATEUR_LEAGUES.includes(selectedLeague);
            let isAmateurSigning = isUserAmateur && p.rating <= 60;

            // CHECK USASA CAP
            if (selectedLeague === 'USASA' && usasaSigningsCount >= 2) {
                alert("USASA Rule: Maximum of 2 signings allowed per season!");
                return;
            }

            // CALCULATE COST
            let weeklyWage = getPlayerWeeklySalary(p.rating);
            
            // FIX: Force cost to 0 if it's an amateur signing
            if (isAmateurSigning) {
                weeklyWage = 0;
            }

            let seasonCost = weeklyWage * 34;
            let transferFee = (p.team !== "Free Agent" && !isAmateurSigning) ? weeklyWage * 50 : 0;
            let totalImpact = seasonCost + transferFee;
            let currentFunds = gameState.budget - gameState.budgetSpent;

            // CHECK FUNDS
            if (totalImpact > currentFunds) {
                alert(`Insufficient Funds!\nCost: $${totalImpact.toLocaleString()}\nAvailable: $${currentFunds.toLocaleString()}`);
                return;
            }

            // EXECUTE SIGNING
            if (confirm(`Sign ${p.name}?`)) {
                p.team = selectedTeam;
                p.matchStamina = typeof getTrainingStaminaCap === 'function' ? getTrainingStaminaCap() : 100;
                p.stats = { matches: 0, goals: 0, assists: 0 };
                
                teamPlayers.push(p);
                gameState.budgetSpent += seasonCost;
                
                if (selectedLeague === 'USASA') usasaSigningsCount++;

                // Visual Update: Remove row instantly
                if(btn) {
                    let row = btn.closest('tr');
                    if(row) row.remove();
                }
                
                showReserves(); // Background refresh
            }
        }

        

        function buildLoadMoreButton() {
            return `
                <div id="load-more-container" style="text-align: center; padding: 20px;">
                    <button onclick="loadTransferList('free', true)" style="background: #333; color: #fff; border: 1px solid #555; padding: 10px 30px; cursor: pointer; border-radius: 5px;">Load More Players</button>
                </div>
            `;
        }

        function viewNextOpponent() {
    closeAllPanels();
    
    let nextMatch = null;
    for (let i = currentMatchIndex; i < schedule.length; i++) {
        let match = schedule[i];
        if (match.home === selectedTeam || match.away === selectedTeam) {
            nextMatch = match;
            break;
        }
    }

    if (!nextMatch) return;

    let opponentName = nextMatch.home === selectedTeam ? nextMatch.away : nextMatch.home;
    
    // Calculate Strengths
    let myStrength = Math.round(getTeamStrength(selectedTeam));
    let oppStrength = Math.round(getTeamStrength(opponentName));
    
    // Calculate Fitness
    let yourFitness = calculateTeamFitness();
    let oppFitness = Math.floor(Math.random() * 20) + 80;

    let displayHTML = `
        <div class="panel-content" style="text-align: center;">
            <h2 style="color: #d4af37; font-size: 1.3rem;">Next Match</h2>
            ${nextMatch.competition === "Open Cup" ? `<div style="font-size: 1.1rem; color: #d4af37; margin: 10px 0;">üèÜ OPEN CUP - ${nextMatch.round || 'Knockout Round'}</div>` : ''}
            <div style="font-size: 1.5rem; margin: 15px 0; font-weight: bold;">
                ${nextMatch.home} <span style="color:#666; font-size:1rem;">vs</span> ${nextMatch.away}
            </div>
            
            <div style="display: flex; justify-content: space-between; margin: 20px 0; background: #222; padding: 15px; border-radius: 10px;">
                <div style="flex: 1;">
                    <div style="color: #999; font-size: 0.8rem;">Your Rating</div>
                    <div style="font-size: 2rem; color: #4CAF50; font-weight: bold;">${myStrength}</div>
                </div>
                <div style="border-left: 1px solid #444; margin: 0 10px;"></div>
                <div style="flex: 1;">
                    <div style="color: #999; font-size: 0.8rem;">Opponent Rating</div>
                    <div style="font-size: 2rem; color: #ff4444; font-weight: bold;">${oppStrength}</div>
                </div>
            </div>
            
            <div style="background: #222; padding: 10px; border-radius: 5px; margin-bottom: 20px; text-align: left;">
                <div style="font-size: 0.8rem; color: #999; margin-bottom: 5px;">Match Fitness</div>
                <div style="width: 100%; height: 6px; background: #444; border-radius: 3px; margin-bottom: 5px;">
                    <div style="width: ${yourFitness}%; height: 100%; background: #4CAF50;"></div>
                </div>
            </div>

            <button class="action-btn" onclick="simNextMatch()" style="width: 100%; margin-bottom: 10px;">SIM MATCH</button>
            <button class="close-panel" onclick="closePanel('next-opponent-panel')" style="width: 100%; background: #444;">Back</button>
        </div>
    `;

    let panel = document.getElementById('next-opponent-panel');
    panel.innerHTML = displayHTML;
    panel.classList.add('active');
}
        

        function viewSchedule() {
            closeAllPanels();
            
            // Use flexbox and percentages instead of fixed widths
            let scheduleHTML = `
            <div class="panel-content" style="background: #fff; color: #000;">
                <h2 style="color: #000; border-bottom: 2px solid #d4af37; padding-bottom: 10px; font-size: 1.5rem;">Season Schedule</h2>
                <div style="overflow-x: auto;"> <table class="league-table" style="width: 100%; min-width: 400px; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #d4af37; color: #000;">
                                <th style="padding: 8px;">#</th>
                                <th style="padding: 8px;">Comp</th>
                                <th style="padding: 8px;">Match</th>
                                <th style="padding: 8px;">Status</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            schedule.forEach((match, index) => {
                let isUserMatch = match.home === selectedTeam || match.away === selectedTeam;
                let status = index < currentMatchIndex ? "Played" : index === currentMatchIndex ? "NEXT" : "Upcoming";
                let competition = match.competition === "Open Cup" ? "üèÜ OC" : "Lge";
                let rowStyle = isUserMatch ? 'background: #fff8e1;' : 'background: #fff;';
                
                scheduleHTML += `
                    <tr style="${rowStyle} border-bottom: 1px solid #eee; color: #000; font-size: 0.85rem;">
                        <td style="padding: 8px;">${index + 1}</td>
                        <td style="padding: 8px;">${competition}</td>
                        <td style="padding: 8px;">${match.home} vs ${match.away}</td>
                        <td style="padding: 8px; font-weight: bold; color: ${index === currentMatchIndex ? '#d4af37' : '#666'};">${status}</td>
                    </tr>
                `;
            });
            
            scheduleHTML += `</tbody></table></div>
                <button class="close-panel" onclick="closePanel('schedule-panel')" style="background: #333; color: #fff;">Close</button>
            </div>`;
            
            let panel = document.getElementById('schedule-panel');
            panel.innerHTML = scheduleHTML;
            panel.classList.add('active');
        }

        function checkSeasonEnd() {
            // Sort standings to find winner
            let sortedStandings = [...leagueStandings].sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (b.goalDifference !== a.goalDifference) return b.goalDifference - a.goalDifference;
                return b.goalsFor - a.goalsFor;
            });
            
            let winner = sortedStandings[0];
            let userStanding = sortedStandings.find(s => s.team === selectedTeam);
            let userPosition = sortedStandings.indexOf(userStanding) + 1;
            
            // Record league finish
            gameState.trophies.leagueHistory.push({
                season: gameState.season,
                league: selectedLeague,
                position: userPosition,
                points: userStanding.points
            });
            
            let message = `üèÅ SEASON ${gameState.season} COMPLETE!\n\n`;
            message += `üìä Final Standing: ${userPosition}/${sortedStandings.length}\n`;
            message += `üéØ Points: ${userStanding.points}\n\n`;
            
            // Award trophy if won
            if (winner.team === selectedTeam) {
                gameState.trophies.leagueTitles++;
                message += `üèÜ CHAMPIONS! üèÜ\n`;
                message += `You won the ${selectedLeague}!\n\n`;
                message += `üèÜ Total League Titles: ${gameState.trophies.leagueTitles}\n`;
            } else {
                message += `${winner.team} won the league with ${winner.points} points.\n\n`;
            }
            
            // Show Open Cup progress if participated
            if (gameState.openCupProgress) {
                message += `\nüèÜ Open Cup: ${gameState.openCupProgress}`;
            }
            
            alert(message);
            
            // Apply training improvements and start new season
            applySeasonTrainingImprovements();
            alert("Starting new season...");
            initializeSeason();
            updateMatchInfo();
        }

        // ============================================
        // MATCH SIMULATION FUNCTIONS
        // ============================================
        
        function simulateHalf(home, away, staminaMod) {
            let hStr = getTeamStrength(home);
            let aStr = getTeamStrength(away);
            
            // Apply stamina to user team
            if(home === selectedTeam) hStr *= staminaMod;
            if(away === selectedTeam) aStr *= staminaMod;
            
            // Apply random stamina drop to opponent in second half (70-100%)
            if (staminaMod < 1) {
                let opponentStamina = 0.70 + (Math.random() * 0.30);
                if (home !== selectedTeam) hStr *= opponentStamina;
                if (away !== selectedTeam) aStr *= opponentStamina;
            }

            let totalStr = hStr + aStr;
            let basePossessionHome = (hStr / totalStr) * 100;
            
            let homePossession = basePossessionHome;
            let awayPossession = 100 - basePossessionHome;
            
            if (home === selectedTeam) {
                if (gameState.playStyle === 'aggressive') {
                    homePossession = Math.min(homePossession * 1.15, 75);
                } else if (gameState.playStyle === 'passive') {
                    homePossession = homePossession * 0.85;
                }
                awayPossession = 100 - homePossession;
            } else if (away === selectedTeam) {
                if (gameState.playStyle === 'aggressive') {
                    awayPossession = Math.min(awayPossession * 1.15, 75);
                } else if (gameState.playStyle === 'passive') {
                    awayPossession = awayPossession * 0.85;
                }
                homePossession = 100 - awayPossession;
            }

            let diff = hStr - aStr;
            let goalsHome = 0, goalsAway = 0;
            let homeScorers = [];
            let awayScorers = [];
            let homeCards = { yellow: [], red: [] };
            let awayCards = { yellow: [], red: [] };
            
            let expHome = 1.0 + (diff>0 ? diff/10 : 0);
            let expAway = 1.0 + (diff<0 ? Math.abs(diff)/10 : 0);
            
            for (let i = 0; i < 3; i++) {
                if (Math.random() < expHome/3) {
                    let scorer = determineScorer(home, true);
                    if (scorer) {
                        goalsHome++;
                        homeScorers.push(scorer);
                    }
                }
            }
            
            for (let i = 0; i < 3; i++) {
                if (Math.random() < expAway/3) {
                    let scorer = determineScorer(away, false);
                    if (scorer) {
                        goalsAway++;
                        awayScorers.push(scorer);
                    }
                }
            }
            
            if (home === selectedTeam) simulateCards(true, homeCards);
            if (away === selectedTeam) simulateCards(false, awayCards);
            
            return { 
                homeGoals: goalsHome, 
                awayGoals: goalsAway,
                homeScorers: homeScorers,
                awayScorers: awayScorers,
                homePossession: Math.round(homePossession),
                awayPossession: Math.round(awayPossession),
                homeCards: homeCards,
                awayCards: awayCards
            };
        }

        function determineScorer(teamName, isHome) {
            if (teamName !== selectedTeam) {
                return { name: 'Opponent Player', player: null };
            }
            
            let starting11 = teamPlayers.slice(0, 11);
            let attackers = starting11.filter((p, i) => i >= 8);
            let midfielders = starting11.filter((p, i) => i >= 5 && i < 8);
            let defenders = starting11.filter((p, i) => i >= 1 && i < 5);
            
            let scoringPool = [];
            
            attackers.forEach(player => {
                let weight = player.rating * 3;
                scoringPool.push({ player, weight });
            });
            
            midfielders.forEach(player => {
                let weight = player.rating * 1.5;
                scoringPool.push({ player, weight });
            });
            
            defenders.forEach(player => {
                let weight = player.rating * 0.3;
                scoringPool.push({ player, weight });
            });
            
            let totalWeight = scoringPool.reduce((sum, item) => sum + item.weight, 0);
            let random = Math.random() * totalWeight;
            let cumulative = 0;
            
            for (let item of scoringPool) {
                cumulative += item.weight;
                if (random <= cumulative) {
                    let cleanName = item.player.name.replace(/\(\d+\)/g, '').trim();
                    if (item.player.stats) {
                        item.player.stats.goals++;
                    }
                    return { name: cleanName, player: item.player };
                }
            }
            
            let striker = starting11[9];
            if (striker.stats) striker.stats.goals++;
            return { name: striker.name.replace(/\(\d+\)/g, '').trim(), player: striker };
        }

        function simulateCards(isHomeTeam, cardsObj) {
            let starting11 = teamPlayers.slice(0, 11);
            
            let yellowChance = 0.15;
            let redChance = 0.02;
            
            if (gameState.playStyle === 'aggressive') {
                yellowChance = 0.30;
                redChance = 0.05;
            } else if (gameState.playStyle === 'passive') {
                yellowChance = 0.05;
                redChance = 0.005;
            }
            
            if (Math.random() < yellowChance) {
                let player = starting11[Math.floor(Math.random() * 11)];
                if (player.stats) {
                    player.stats.yellowCards++;
                    cardsObj.yellow.push(player.name.replace(/\(\d+\)/g, '').trim());
                    
                    if (player.stats.yellowCards >= 5) {
                        player.stats.suspended = true;
                        player.stats.yellowCards = 0;
                        player.stats.yellowCardRisk = false;
                    } else if (player.stats.yellowCards === 4) {
                        player.stats.yellowCardRisk = true;
                    }
                }
            }
            
            if (Math.random() < redChance) {
                let player = starting11[Math.floor(Math.random() * 11)];
                if (player.stats) {
                    player.stats.redCards++;
                    player.stats.suspended = true;
                    cardsObj.red.push(player.name.replace(/\(\d+\)/g, '').trim());
                }
            }
        }

        function simNextMatch() {
            closePanel('next-opponent-panel'); // Ensure panel is closed
            
            let starting11; // Declare once for the entire function
            
            // Check for suspended players BEFORE match starts (not at half-time)
            if (matchHalf === 0) {
                starting11 = teamPlayers.slice(0, 11);
                let suspended = starting11.filter(p => p.stats && p.stats.suspended);
                
                if (suspended.length > 0) {
                    let names = suspended.map(p => p.name.replace(/\(\d+\)/g, '').trim()).join('\n‚Ä¢ ');
                    alert(`‚õî Cannot Start Match!\n\nSuspended players in starting XI:\n‚Ä¢ ${names}\n\nPlease substitute them before continuing.`);
                    showReserves(); // Auto-open reserves
                    return;
                }
            }
            
            checkOpenCupStart();
            
            if (currentMatchIndex >= schedule.length) {
                applySeasonTrainingImprovements();
                alert("Season complete! Starting new season...");
                initializeSeason();
                updateMatchInfo();
                return;
            }

            let match = schedule[currentMatchIndex];
            let isOpenCupMatch = match.competition === "Open Cup";
            
            // --- FIRST HALF ---
            if (matchHalf === 0) {
                matchHalf = 1;
                
                // Initialize stamina for all players at 100
                teamPlayers.forEach(p => p.matchStamina = 100);
                
                let result = simulateHalf(match.home, match.away, 1.0);
                firstHalfResult = result;
                
                // Drain stamina based on position after first half
                starting11 = teamPlayers.slice(0, 11); // Reuse variable
                const formationPositions = ['GK', 'LB', 'CB', 'CB', 'RB', 'CM', 'CDM', 'CM', 'LW', 'ST', 'RW'];
                
                starting11.forEach((player, index) => {
                    let position = formationPositions[index];
                    
                    // Position-based stamina drain
                    if (position === 'GK') {
                        player.matchStamina = 95; // Keepers barely tire
                    } else if (position === 'CB') {
                        player.matchStamina = 85; // Center backs
                    } else if (position === 'LB' || position === 'RB') {
                        player.matchStamina = 75; // Full backs run a lot
                    } else if (position === 'ST' || position === 'CF') {
                        player.matchStamina = 80; // Strikers
                    } else if (position === 'LW' || position === 'RW') {
                        player.matchStamina = 75; // Wingers run constantly
                    } else { // Midfielders (CM, CDM, CAM)
                        player.matchStamina = 70; // Midfielders work hardest
                    }
                });
                
                // Update display to show drained stamina
                displayStarting11();
                
                showHalfTime(match, result, isOpenCupMatch);
                return;
            }
            
            // --- SECOND HALF ---
            if (matchHalf === 1) {
                matchHalf = 0; // Reset match half
                
                // Calculate stamina modifier for user's team (average of starting 11)
                starting11 = teamPlayers.slice(0, 11); // Reuse variable from above
                let avgStamina = starting11.reduce((sum, p) => sum + (p.matchStamina || 100), 0) / 11;
                let staminaMod = avgStamina / 100; // Convert to 0.0-1.0 multiplier
                
                let secondHalfResult = simulateHalf(match.home, match.away, staminaMod);
                
                // Merge both halves
                let fullResult = {
                    homeGoals: firstHalfResult.homeGoals + secondHalfResult.homeGoals,
                    awayGoals: firstHalfResult.awayGoals + secondHalfResult.awayGoals,
                    homeScorers: [...(firstHalfResult.homeScorers || []), ...(secondHalfResult.homeScorers || [])],
                    awayScorers: [...(firstHalfResult.awayScorers || []), ...(secondHalfResult.awayScorers || [])],
                    homePossession: Math.round((firstHalfResult.homePossession + secondHalfResult.homePossession) / 2),
                    awayPossession: Math.round((firstHalfResult.awayPossession + secondHalfResult.awayPossession) / 2),
                    homeCards: {
                        yellow: [...(firstHalfResult.homeCards?.yellow || []), ...(secondHalfResult.homeCards?.yellow || [])],
                        red: [...(firstHalfResult.homeCards?.red || []), ...(secondHalfResult.homeCards?.red || [])]
                    },
                    awayCards: {
                        yellow: [...(firstHalfResult.awayCards?.yellow || []), ...(secondHalfResult.awayCards?.yellow || [])],
                        red: [...(firstHalfResult.awayCards?.red || []), ...(secondHalfResult.awayCards?.red || [])]
                    }
                };
                
                // Update match appearances for starters
                starting11 = teamPlayers.slice(0, 11); // Reuse variable
                starting11.forEach(player => {
                    if (player.stats) player.stats.appearances++;
                });
                
                if (!isOpenCupMatch) {
                    updateStandings(match.home, match.away, fullResult);
                }
                
                firstHalfResult = null;
                
                // RESET THE BUTTON (Crucial Fix)
                let actionBtn = document.getElementById('match-action-btn');
                actionBtn.onclick = viewNextOpponent;
                actionBtn.innerText = 'VIEW NEXT OPPONENT';
                actionBtn.style.background = ""; // Remove red color
                
                let userMatch = null;
                if (match.home === selectedTeam || match.away === selectedTeam) {
                    userMatch = {
                        home: match.home,
                        away: match.away,
                        homeGoals: fullResult.homeGoals,
                        awayGoals: fullResult.awayGoals,
                        homeScorers: fullResult.homeScorers,
                        awayScorers: fullResult.awayScorers,
                        homePossession: fullResult.homePossession,
                        awayPossession: fullResult.awayPossession,
                        homeCards: fullResult.homeCards,
                        awayCards: fullResult.awayCards,
                        isUserHome: match.home === selectedTeam,
                        competition: isOpenCupMatch ? `Open Cup - ${match.round}` : selectedLeague,
                        isOpenCup: isOpenCupMatch
                    };
                    
                    if (isOpenCupMatch) {
                        let winner = fullResult.homeGoals > fullResult.awayGoals ? match.home : 
                                     fullResult.homeGoals < fullResult.awayGoals ? match.away : 
                                     Math.random() < 0.5 ? match.home : match.away; 
                        
                        if (winner !== selectedTeam) {
                            qualifiedForOpenCup = false;
                            gameState.openCupProgress = match.round + " - Eliminated";
                            if (match.round === "Final") {
                                gameState.prizesMoney += PRIZES.OPEN_CUP_RUNNER_UP;
                                alert(`Runner-up! You earned $${PRIZES.OPEN_CUP_RUNNER_UP.toLocaleString()}`);
                            }
                        } else {
                            gameState.openCupProgress = match.round + " - Winner";
                            if (match.round === "Final") {
                                gameState.prizesMoney += PRIZES.OPEN_CUP_WINNER;
                                alert(`üèÜ OPEN CUP CHAMPION! You earned $${PRIZES.OPEN_CUP_WINNER.toLocaleString()}`);
                                openCupActive = false;
                            } else {
                                insertNextOpenCupMatch();
                            }
                        }
                    }
                }
                
                currentMatchIndex++;
                gameState.matchesPlayed++;
                
                // Restore all players to 100 stamina after match
                teamPlayers.forEach(p => p.matchStamina = 100);
                
                // Restore default starting XI (revert any in-game subs)
                restoreDefaultStarting11();
                displayStarting11();
                
                updateMatchInfo();

                if (userMatch) {
                    displayMatchResult(userMatch);
                }
                
                // Silent Auto-Save (Fixes "popup every game" issue)
                if (typeof saveGame === "function") saveGame(false);
            }
        }
        
        function handleOpenCupResult(match, result) {
            // Determine winner (penalties if draw)
            let winner;
            if (result.homeGoals > result.awayGoals) {
                winner = match.home;
            } else if (result.awayGoals > result.homeGoals) {
                winner = match.away;
            } else {
                // Penalty shootout
                winner = Math.random() < 0.5 ? match.home : match.away;
            }
            
            // Check if user won or lost
            let userWon = winner === selectedTeam;
            let userLost = (match.home === selectedTeam || match.away === selectedTeam) && !userWon;
            
            if (userLost) {
                // Eliminated
                qualifiedForOpenCup = false;
                gameState.trophies.cupHistory.push({
                    season: gameState.season,
                    competition: 'US Open Cup',
                    round: match.round,
                    result: 'Eliminated'
                });
                
                // Runner-up prize
                if (match.round === 'Final') {
                    gameState.prizesMoney += PRIZES.OPEN_CUP_RUNNER_UP;
                    gameState.openCupProgress = 'Runner-up';
                }
            } else if (userWon) {
                // Check if this was the final
                if (match.round === 'Final') {
                    // WON THE OPEN CUP!
                    gameState.trophies.openCupWins++;
                    gameState.prizesMoney += PRIZES.OPEN_CUP_WINNER;
                    gameState.openCupProgress = 'Champion';
                    gameState.trophies.cupHistory.push({
                        season: gameState.season,
                        competition: 'US Open Cup',
                        round: 'Final',
                        result: 'Winner'
                    });
                    
                    setTimeout(() => {
                        alert(`üèÜüèÜüèÜ US OPEN CUP CHAMPIONS! üèÜüèÜüèÜ\n\nYou won the Open Cup!\n\nüí∞ Prize Money: $${PRIZES.OPEN_CUP_WINNER.toLocaleString()}\nüèÜ Total Open Cup Wins: ${gameState.trophies.openCupWins}`);
                    }, 500);
                    
                    openCupActive = false;
                    qualifiedForOpenCup = false;
                } else {
                    // Advanced to next round
                    gameState.openCupProgress = match.round + ' Winner';
                    insertNextOpenCupMatch();
                }
            }
        }
        
        // Helper to get the starting max based on training
        function getTrainingStaminaCap() {
            if(trainingIntensity === 1) return 100; // Light
            if(trainingIntensity === 2) return 85;  // Moderate
            return 75; // Heavy
        }

        function applySeasonTrainingImprovements() {
            let improvements = [];
            
            let baseImprovement = trainingIntensity === 1 ? 1 : 2;
            
            const RATING_CAPS = {
                'USASA': 50,
                'NPSL': 55,
                'UPSL': 55,
                'USL League 2': 60,
                'NISA': 70,
                'USL League One': 70,
                'MLS Next Pro': 75,
                'USL Championship': 80,
                'MLS': 95
            };
            
            let maxRating = RATING_CAPS[selectedLeague] || 95;
            
            teamPlayers.forEach(player => {
                let oldRating = player.rating;
                let ratingChange = baseImprovement;
                
                // Age players by 1 year
                player.age = (player.age || 25) + 1;
                
                // Age-based decline: 35+ lose 1 point per season
                if (player.age >= 35) {
                    ratingChange -= 1;
                    improvements.push(`${player.name} (Age ${player.age}): Declining with age`);
                }
                
                let newRating = Math.min(player.rating + ratingChange, maxRating);
                newRating = Math.max(newRating, 30); // Minimum rating of 30
                
                player.rating = newRating;
                if (newRating !== oldRating) {
                    improvements.push(`${player.name}: ${oldRating} ‚Üí ${newRating} (Age ${player.age})`);
                }
            });
            
            if (trainingIntensity === 3 && Math.random() < 0.5) {
                let starting11 = teamPlayers.slice(0, 11);
                let halfCount = Math.floor(starting11.length / 2);
                
                let shuffled = [...starting11].sort(() => Math.random() - 0.5);
                let bonusPlayers = shuffled.slice(0, halfCount);
                
                bonusPlayers.forEach(player => {
                    let oldRating = player.rating;
                    let newRating = Math.min(player.rating + 1, maxRating);
                    if (newRating > oldRating) {
                        player.rating = newRating;
                        improvements.push(`${player.name}: BONUS +1! (${oldRating} ‚Üí ${newRating})`);
                    }
                });
                
                alert(`üéâ Training Bonus! ${halfCount} players got an extra +1 rating!`);
            }
            
            gameState.budgetSpent = calculateCurrentSpending();
            
            console.log("Season Training Improvements:", improvements);
            alert(`Season complete!\nTraining ${trainingIntensity}x/week improved your squad!\n\nAll players: +${baseImprovement} rating (capped at ${maxRating})\nPlayers 35+ experienced age decline.`);
        }

        function getTeamStamina(teamName) {
            if (teamName === selectedTeam) {
                if (trainingIntensity === 1) return 1.0;  
                if (trainingIntensity === 2) return 0.85; 
                return 0.75; 
            } else {
                let rand = Math.random();
                if (rand < 0.6) return 1.0;
                if (rand < 0.84) return 0.85;
                return 0.75;
            }
        }

        function getPlayerStamina(playerIndex) {
            let isStarter = teamPlayers.slice(0, 11).includes(teamPlayers[playerIndex]);
            
            if (isStarter) {
                if (trainingIntensity === 1) return 100;
                if (trainingIntensity === 2) return 85;
                if (trainingIntensity === 3) return 75;
            }
            return 100;
        }

        function calculateTeamFitness() {
            let starting11 = teamPlayers.slice(0, 11);
            let totalStamina = 0;
            
            starting11.forEach(p => {
                let stamina = (trainingIntensity === 1) ? 100 : (trainingIntensity === 2) ? 85 : 75;
                totalStamina += stamina;
            });
            
            return Math.round(totalStamina / 11);
        }

        function updateStaminaDisplay() {
            let fitness = calculateTeamFitness();
            let barColor = fitness > 90 ? '#4CAF50' : fitness > 80 ? '#d4af37' : '#ff4444';
            
            let html = `
                <div style="margin-bottom: 20px; padding: 15px; background: #2a2a2a; border-radius: 5px; border: 1px solid #444;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="color: #ccc; font-size: 0.9rem;">Match Fitness (Starting XI)</span>
                        <span style="color: ${barColor}; font-weight: bold;">${fitness}%</span>
                    </div>
                    <div style="width: 100%; height: 10px; background: #111; border-radius: 5px; overflow: hidden;">
                        <div style="width: ${fitness}%; height: 100%; background: ${barColor}; transition: width 0.3s;"></div>
                    </div>
                    <div style="font-size: 0.75rem; color: #777; margin-top: 5px;">
                        *Sub in players from reserves (100% stamina) to boost this.
                    </div>
                </div>
            `;
            
            let sidebar = document.querySelector('.sidebar-menu');
            let existingBar = document.getElementById('stamina-container');
            
            if (existingBar) {
                existingBar.innerHTML = html;
            } else {
                let div = document.createElement('div');
                div.id = 'stamina-container';
                div.innerHTML = html;
                sidebar.insertBefore(div, sidebar.children[1]);
            }
        }

        function showHalfTime(match, result, isOpenCup) {
            // 1. Update Sidebar Button (Backup)
            let actionBtn = document.getElementById('match-action-btn');
            actionBtn.onclick = simSecondHalf;
            actionBtn.innerText = 'SIM 2ND HALF';
            actionBtn.style.background = "#ff4444"; // Red to indicate match in progress
            
            // 2. Create the Modal HTML with BUTTONS
            let halftimeHTML = `
                <div style="text-align: center; padding: 10px; max-width: 600px; margin: 0 auto;">
                    <h2 style="color: #d4af37; font-size: 2rem; margin-bottom: 15px;">HALF TIME</h2>
                    ${isOpenCup ? `<div style="font-size: 1rem; color: #d4af37; margin-bottom: 10px;">üèÜ ${match.round}</div>` : ''}
                    
                    <div style="font-size: 1.5rem; margin: 15px 0;">
                        <strong>${match.home}</strong> vs <strong>${match.away}</strong>
                    </div>
                    
                    <div style="font-size: 3.5rem; color: #d4af37; margin: 20px 0; font-weight:bold;">
                        ${result.homeGoals} - ${result.awayGoals}
                    </div>
                    
                    <div style="display:flex; gap: 15px; justify-content: center; margin-top: 30px;">
                        <button onclick="document.getElementById('match-result-panel').classList.remove('active')" 
                                style="background: #333; color: white; border: 1px solid #fff; font-size: 1rem; padding: 15px 20px;">
                            Manage Team
                        </button>
                        
                        <button onclick="simNextMatch()" 
                                style="background: #d4af37; color: black; font-size: 1rem; padding: 15px 20px; font-weight:bold;">
                            Start 2nd Half
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('match-result-display').innerHTML = halftimeHTML;
            document.getElementById('match-result-panel').classList.add('active');
        }
		
        function simSecondHalf() {
            simNextMatch();
        }

        // Position mapping for generic positions
        function normalizePosition(pos) {
            if (!pos) return pos;
            pos = pos.toUpperCase();
            
            // Map RM/LM to RW/LW
            if (pos === 'RM') return 'RW';
            if (pos === 'LM') return 'LW';
            
            return pos;
        }

        // Calculate rating penalty for out-of-position players
        function getPositionPenalty(playerPosition, slotPosition) {
            playerPosition = normalizePosition(playerPosition);
            slotPosition = normalizePosition(slotPosition);
            
            // GK can only play GK
            if (playerPosition === 'GK' && slotPosition !== 'GK') return -999; // Impossible
            if (slotPosition === 'GK' && playerPosition !== 'GK') return -999; // Impossible
            if (playerPosition === 'GK' && slotPosition === 'GK') return 0; // Perfect
            
            // Generic MF can play anywhere in midfield with -1
            if (playerPosition === 'MF' || playerPosition === 'M') {
                if (['CM', 'CDM', 'CAM', 'LM', 'RM', 'LW', 'RW'].includes(slotPosition)) {
                    return -1;
                }
            }
            
            // Generic DF can play anywhere in defense with -1
            if (playerPosition === 'DF' || playerPosition === 'D') {
                if (['CB', 'LB', 'RB'].includes(slotPosition)) {
                    return -1;
                }
            }
            
            // Same position = no penalty
            if (playerPosition === slotPosition) return 0;
            
            // RB/LB penalties
            if (playerPosition === 'RB' || playerPosition === 'LB') {
                if (slotPosition === 'CB') return -1;
                if (slotPosition === 'RW' || slotPosition === 'LW') return -1;
                if (slotPosition === 'CM' || slotPosition === 'CDM' || slotPosition === 'CAM') return -2;
                if (slotPosition === 'CF' || slotPosition === 'ST') return -3;
                if (slotPosition === 'RB' || slotPosition === 'LB') return 0; // LB can play RB and vice versa
            }
            
            // CB penalties
            if (playerPosition === 'CB') {
                if (slotPosition === 'RB' || slotPosition === 'LB') return -1;
                if (slotPosition === 'CM' || slotPosition === 'CDM' || slotPosition === 'CAM') return -2;
                if (slotPosition === 'RW' || slotPosition === 'LW') return -2;
                if (slotPosition === 'CF' || slotPosition === 'ST') return -2;
            }
            
            // CM penalties (CDM, CAM treated as CM)
            if (playerPosition === 'CM' || playerPosition === 'CDM' || playerPosition === 'CAM') {
                if (slotPosition === 'CF' || slotPosition === 'ST') return -1;
                if (slotPosition === 'CB') return -2;
                if (slotPosition === 'RB' || slotPosition === 'LB') return -2;
                if (slotPosition === 'RW' || slotPosition === 'LW') return -2;
                if (slotPosition === 'CM' || slotPosition === 'CDM' || slotPosition === 'CAM') return 0; // All CMs interchangeable
            }
            
            // LW/RW penalties
            if (playerPosition === 'LW' || playerPosition === 'RW') {
                if (slotPosition === 'CF' || slotPosition === 'ST') return -1;
                if (slotPosition === 'CM' || slotPosition === 'CDM' || slotPosition === 'CAM') return -2;
                if (slotPosition === 'RB' || slotPosition === 'LB') return -2;
                if (slotPosition === 'CB') return -3;
                if (slotPosition === 'LW' || slotPosition === 'RW') return 0; // LW can play RW and vice versa
            }
            
            // CF/ST penalties
            if (playerPosition === 'CF' || playerPosition === 'ST') {
                if (slotPosition === 'LW' || slotPosition === 'RW') return -1;
                if (slotPosition === 'CM' || slotPosition === 'CDM' || slotPosition === 'CAM') return -2;
                if (slotPosition === 'CB') return -3;
                if (slotPosition === 'RB' || slotPosition === 'LB') return -3;
                if (slotPosition === 'CF' || slotPosition === 'ST') return 0; // CF and ST interchangeable
            }
            
            // Default: large penalty for unlisted combinations
            return -5;
        }

        function getTeamStrength(teamName) {
            if (teamName === selectedTeam) {
                // User team: Use current starting 11 with position penalties
                let starting11 = teamPlayers.slice(0, 11);
                const formationPositions = ['GK', 'LB', 'CB', 'CB', 'RB', 'CM', 'CDM', 'CM', 'LW', 'ST', 'RW'];
                
                let totalRating = 0;
                starting11.forEach((player, index) => {
                    let slotPosition = formationPositions[index];
                    let penalty = getPositionPenalty(player.position, slotPosition);
                    let effectiveRating = Math.max(player.rating + penalty, 1);
                    totalRating += effectiveRating;
                });
                
                return totalRating / 11;
            } else {
                // Opponent team: Build best possible XI by position
                let allPlayers = db.filter(p => p.team === teamName);
                if (allPlayers.length === 0) return 50;
                
                const formationPositions = ['GK', 'LB', 'CB', 'CB', 'RB', 'CM', 'CDM', 'CM', 'LW', 'ST', 'RW'];
                let selectedPlayers = [];
                let availablePlayers = [...allPlayers];
                
                // Try to fill each position with best available
                formationPositions.forEach(targetPos => {
                    let bestPlayer = null;
                    let bestIndex = -1;
                    
                    // Priority 1: Exact position match
                    for (let i = 0; i < availablePlayers.length; i++) {
                        if (availablePlayers[i].position === targetPos) {
                            if (!bestPlayer || availablePlayers[i].rating > bestPlayer.rating) {
                                bestPlayer = availablePlayers[i];
                                bestIndex = i;
                            }
                        }
                    }
                    
                    // Priority 2: Similar position (if no exact match)
                    if (!bestPlayer) {
                        let similarPositions = getSimilarPositions(targetPos);
                        for (let i = 0; i < availablePlayers.length; i++) {
                            if (similarPositions.includes(availablePlayers[i].position)) {
                                if (!bestPlayer || availablePlayers[i].rating > bestPlayer.rating) {
                                    bestPlayer = availablePlayers[i];
                                    bestIndex = i;
                                }
                            }
                        }
                    }
                    
                    // Priority 3: Same category (DEF/MID/ATT)
                    if (!bestPlayer) {
                        let category = getPositionCategory(targetPos);
                        for (let i = 0; i < availablePlayers.length; i++) {
                            if (getPositionCategory(availablePlayers[i].position) === category) {
                                if (!bestPlayer || availablePlayers[i].rating > bestPlayer.rating) {
                                    bestPlayer = availablePlayers[i];
                                    bestIndex = i;
                                }
                            }
                        }
                    }
                    
                    // Priority 4: Anyone (fallback)
                    if (!bestPlayer && availablePlayers.length > 0) {
                        bestPlayer = availablePlayers[0];
                        bestIndex = 0;
                        for (let i = 1; i < availablePlayers.length; i++) {
                            if (availablePlayers[i].rating > bestPlayer.rating) {
                                bestPlayer = availablePlayers[i];
                                bestIndex = i;
                            }
                        }
                    }
                    
                    if (bestPlayer) {
                        selectedPlayers.push(bestPlayer);
                        availablePlayers.splice(bestIndex, 1);
                    }
                });
                
                // If we don't have 11 players, fill with remaining
                while (selectedPlayers.length < 11 && availablePlayers.length > 0) {
                    selectedPlayers.push(availablePlayers.shift());
                }
                
                // Calculate average rating
                if (selectedPlayers.length === 0) return 50;
                let avgRating = selectedPlayers.reduce((sum, p) => sum + p.rating, 0) / selectedPlayers.length;
                return avgRating;
            }
        }
        
        function getSimilarPositions(targetPos) {
            const similarMap = {
                'GK': [],
                'LB': ['RB', 'LWB', 'RWB'],
                'RB': ['LB', 'LWB', 'RWB'],
                'CB': ['LB', 'RB'],
                'CDM': ['CM', 'CAM'],
                'CM': ['CDM', 'CAM', 'LM', 'RM'],
                'LW': ['RW', 'LM', 'ST'],
                'RW': ['LW', 'RM', 'ST'],
                'ST': ['CF', 'LW', 'RW'],
                'CF': ['ST', 'CAM']
            };
            return similarMap[targetPos] || [];
        }
        
        function getPositionCategory(position) {
            if (!position) return 'MID';
            position = position.toUpperCase();
            
            if (position === 'GK') return 'GK';
            if (['CB', 'LB', 'RB', 'LWB', 'RWB'].includes(position)) return 'DEF';
            if (['CDM', 'CM', 'CAM', 'LM', 'RM'].includes(position)) return 'MID';
            if (['LW', 'RW', 'ST', 'CF'].includes(position)) return 'ATT';
            
            return 'MID'; // Default
        }

        function generateGoals(expectedGoals) {
            let goals = 0;
            let lambda = expectedGoals;
            
            while (Math.random() < (lambda / (goals + 1))) {
                goals++;
                if (goals > 8) break; 
            }

            return goals;
        }

        function updateStandings(homeTeam, awayTeam, result) {
            let homeStanding = leagueStandings.find(s => s.team === homeTeam);
            let awayStanding = leagueStandings.find(s => s.team === awayTeam);

            if (!homeStanding || !awayStanding) return;

            homeStanding.played++;
            awayStanding.played++;

            homeStanding.goalsFor += result.homeGoals;
            homeStanding.goalsAgainst += result.awayGoals;
            awayStanding.goalsFor += result.awayGoals;
            awayStanding.goalsAgainst += result.homeGoals;

            if (result.homeGoals > result.awayGoals) {
                homeStanding.won++;
                homeStanding.points += 3;
                awayStanding.lost++;
            } else if (result.homeGoals < result.awayGoals) {
                awayStanding.won++;
                awayStanding.points += 3;
                homeStanding.lost++;
            } else {
                homeStanding.drawn++;
                awayStanding.drawn++;
                homeStanding.points++;
                awayStanding.points++;
            }

            homeStanding.goalDifference = homeStanding.goalsFor - homeStanding.goalsAgainst;
            awayStanding.goalDifference = awayStanding.goalsFor - awayStanding.goalsAgainst;
        }

        function displayMatchResult(match) {
            let competitionLabel = match.competition || selectedLeague;
            
            // Format scorers
            let homeScorers = match.homeScorers ? match.homeScorers.map(s => s.name).join(', ') : 'None';
            let awayScorers = match.awayScorers ? match.awayScorers.map(s => s.name).join(', ') : 'None';
            
            // Format cards
            let homeYellows = match.homeCards?.yellow?.join(', ') || 'None';
            let homeReds = match.homeCards?.red?.join(', ') || 'None';
            let awayYellows = match.awayCards?.yellow?.join(', ') || 'None';
            let awayReds = match.awayCards?.red?.join(', ') || 'None';
            
            let resultHTML = `
                <div class="match-result">
                    ${match.isOpenCup ? `<div style="font-size: 1.2rem; color: #d4af37; margin-bottom: 10px;">üèÜ ${competitionLabel}</div>` : ''}
                    <div class="match-teams">
                        ${match.home} vs ${match.away}
                    </div>
                    <div class="match-score">
                        ${match.homeGoals} - ${match.awayGoals}
                    </div>
                    <div style="margin-top: 20px; font-size: 1.5rem;">
                        ${match.homeGoals > match.awayGoals 
                            ? (match.isUserHome ? 'üéâ Victory!' : 'üòû Defeat') 
                            : match.homeGoals < match.awayGoals
                                ? (match.isUserHome ? 'üòû Defeat' : 'üéâ Victory!')
                                : 'ü§ù Draw'}
                    </div>
                    
                    ${match.homeScorers && match.awayScorers ? `
                    <div style="margin-top: 20px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;">
                        <h4 style="color: #d4af37; border-bottom: 2px solid #d4af37; padding-bottom: 5px;">‚öΩ Goal Scorers</h4>
                        <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                            <div style="flex: 1; padding-right: 10px;">
                                <strong>${match.home}:</strong><br>${homeScorers}
                            </div>
                            <div style="flex: 1; padding-left: 10px; border-left: 1px solid #444;">
                                <strong>${match.away}:</strong><br>${awayScorers}
                            </div>
                        </div>
                        
                        <h4 style="color: #d4af37; border-bottom: 2px solid #d4af37; padding-bottom: 5px; margin-top: 15px;">üìä Possession</h4>
                        <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                            <div><strong>${match.home}:</strong> ${match.homePossession}%</div>
                            <div><strong>${match.away}:</strong> ${match.awayPossession}%</div>
                        </div>
                        
                        <h4 style="color: #d4af37; border-bottom: 2px solid #d4af37; padding-bottom: 5px; margin-top: 15px;">üìã Discipline</h4>
                        <div style="margin: 10px 0;">
                            <div style="margin-bottom: 5px;"><strong>üü® Yellow Cards</strong></div>
                            <div style="display: flex; justify-content: space-between;">
                                <div style="flex: 1;">${match.home}: ${homeYellows}</div>
                                <div style="flex: 1; border-left: 1px solid #444; padding-left: 10px;">${match.away}: ${awayYellows}</div>
                            </div>
                        </div>
                        <div style="margin: 10px 0;">
                            <div style="margin-bottom: 5px;"><strong>üü• Red Cards</strong></div>
                            <div style="display: flex; justify-content: space-between;">
                                <div style="flex: 1;">${match.home}: ${homeReds}</div>
                                <div style="flex: 1; border-left: 1px solid #444; padding-left: 10px;">${match.away}: ${awayReds}</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${match.isOpenCup && !qualifiedForOpenCup ? '<div style="margin-top: 15px; color: #ff4444; font-size: 1.2rem;">‚ùå Eliminated from Open Cup</div>' : ''}
                    ${match.isOpenCup && qualifiedForOpenCup ? '<div style="margin-top: 15px; color: #4CAF50; font-size: 1.2rem;">‚úì Advanced to Next Round!</div>' : ''}
                </div>
            `;

            document.getElementById('match-result-display').innerHTML = resultHTML;
            document.getElementById('match-result-panel').classList.add('active');
        }

        function closeMatchResult() {
            document.getElementById('match-result-panel').classList.remove('active');
        }

        function updateMatchInfo() {
            document.getElementById('current-match-num').innerText = currentMatchIndex + 1;
            
            let userStanding = leagueStandings.find(s => s.team === selectedTeam);
            if (userStanding) {
                document.getElementById('team-points').innerText = userStanding.points;
            }

            document.getElementById('team-budget').innerText = gameState.budget.toLocaleString();
            document.getElementById('team-spending').innerText = gameState.budgetSpent.toLocaleString();
            
            let rules = LEAGUE_RULES[selectedLeague];
            if (rules) {
                document.getElementById('team-expectations').innerText = rules.expectations;
            }

            if (gameState.budgetSpent > gameState.budget) {
                document.getElementById('team-spending').style.color = '#ff4444';
            } else {
                document.getElementById('team-spending').style.color = '#d4af37';
            }
        }

        function returnToMenu() {
            if (confirm("Are you sure you want to return to the main menu? Your progress will be lost.")) {
                selectedLeague = "";
                selectedTeam = "";
                teamPlayers = [];
                leagueTeams = [];
                leagueStandings = [];
                schedule = [];
                currentMatchIndex = 0;
                gameState = { season: 1, matchesPlayed: 0 };
                starting11Initialized = false;
                
                document.getElementById('screen-matchday').classList.remove('active');
                document.getElementById('screen-start').classList.add('active');
            }
        }
		
		// --- MOBILE: TAP TO SWAP LOGIC ---
        function handleSwapClick(element, e) {
            // STOP THE CLICK FROM GOING THROUGH
            if (e && e.stopPropagation) e.stopPropagation();

            let clickedIndex = parseInt(element.dataset.playerIndex);

            // --- SELECTION PHASE ---
            if (selectedSwapIndex === null) {
                selectedSwapIndex = clickedIndex;
                element.classList.add('selected-swap');
                element.style.border = "3px solid #00ff00"; 
                
                if (navigator.vibrate) navigator.vibrate(50);

                // If Reserve selected, close panel to see field
                if (clickedIndex >= 11) {
                     setTimeout(() => {
                         closePanel('reserves-panel');
                     }, 150);
                }
                return;
            }

            // --- DESELECT PHASE ---
            if (selectedSwapIndex === clickedIndex) {
                selectedSwapIndex = null;
                element.classList.remove('selected-swap');
                element.style.border = "";
                return;
            }

            // --- SWAP PHASE ---
            let wasReserveSwap = (selectedSwapIndex >= 11 && clickedIndex <= 10) || 
                                 (selectedSwapIndex <= 10 && clickedIndex >= 11);
            
            let temp = teamPlayers[selectedSwapIndex];
            teamPlayers[selectedSwapIndex] = teamPlayers[clickedIndex];
            teamPlayers[clickedIndex] = temp;

            selectedSwapIndex = null;
            
            // If swap happened outside of a match, save as new default
            if (matchHalf === 0) {
                saveDefaultStarting11();
            }

            displayStarting11();
            if (typeof updateStaminaDisplay === "function") updateStaminaDisplay();

            // Re-open Reserves if needed
            if (wasReserveSwap) {
                showReserves();
            } else {
                if (document.getElementById('reserves-panel') && document.getElementById('reserves-panel').classList.contains('active')) {
                    showReserves();
                }
            }
        }

        // --- DESKTOP: DRAG AND DROP LOGIC ---
        function handleReserveDragStart(e) {
            draggedCard = e.currentTarget;
            draggedCard.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', draggedCard.innerHTML);
        }

        function handleDragStart(e) {
            draggedCard = e.currentTarget;
            draggedCard.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', draggedCard.innerHTML);
        }

        function handleDragEnd(e) {
            if (draggedCard) {
                draggedCard.classList.remove('dragging');
                document.querySelectorAll('.player-position').forEach(card => {
                    card.classList.remove('drop-target');
                });
                draggedCard = null;
            }
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (e.currentTarget !== draggedCard && e.currentTarget.classList.contains('player-position')) {
                e.currentTarget.classList.add('drop-target');
            }
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drop-target');
        }

        function handleCardDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            e.preventDefault();

            let dropTarget = e.currentTarget;
            
            if (draggedCard && dropTarget !== draggedCard && dropTarget.classList.contains('player-position')) {
                
                if (draggedCard.dataset.fromReserves === 'true') {
                    // Swap Reserve -> Starter
                    let reservePlayerIndex = parseInt(draggedCard.dataset.playerIndex);
                    let startingPlayerIndex = parseInt(dropTarget.dataset.playerIndex);
                    
                    let temp = teamPlayers[reservePlayerIndex];
                    teamPlayers[reservePlayerIndex] = teamPlayers[startingPlayerIndex];
                    teamPlayers[startingPlayerIndex] = temp;
                    
                    displayStarting11();
                    if (document.getElementById('reserves-panel').classList.contains('active')) {
                        showReserves();
                    }
                } else {
                    // Swap Starter -> Starter
                    let draggedPlayerIndex = parseInt(draggedCard.dataset.playerIndex);
                    let targetPlayerIndex = parseInt(dropTarget.dataset.playerIndex);
                    
                    let temp = teamPlayers[draggedPlayerIndex];
                    teamPlayers[draggedPlayerIndex] = teamPlayers[targetPlayerIndex];
                    teamPlayers[targetPlayerIndex] = temp;
                    
                    displayStarting11();
                }
                
                if (typeof updateStaminaDisplay === "function") updateStaminaDisplay();
                dropTarget.classList.remove('drop-target');
            }
            return false;
        }
		
		function openPlayerManageModal(index) {
            let p = teamPlayers[index];
            let modal = document.getElementById('manage-player-modal');
            let wage = getPlayerWeeklySalary(p.rating);
            // Market Value Formula: Rating * 2000 * Multiplier
            let marketValue = p.rating * 2000 * (1 + (p.rating-50)*0.1); 
            if(marketValue < 0) marketValue = 0;

            let html = `
                <div class="panel-content" style="max-width:400px; text-align:center;">
                    <h2 style="color:#d4af37">${p.name}</h2>
                    <p>${p.position} | Rating: ${p.rating} | Age: ${p.age}</p>
                    <hr style="border-color:#444">
                    
                    ${p.rating >= 60 ? `
                        <div style="margin:20px 0; background:#222; padding:10px;">
                            <div style="color:#ccc; font-size:0.9rem;">Estimated Value: $${Math.round(marketValue).toLocaleString()}</div>
                            <input type="number" id="askPrice" placeholder="Asking Price" style="width:150px; font-size:1rem; padding:5px; margin-top:5px;">
                            <br><button onclick="attemptSellPlayer(${index}, ${marketValue})" style="width:100%; font-size:1rem; margin-top:5px;">List for Sale</button>
                        </div>
                    ` : `<p style="color:#999; font-size:0.8rem;">Rating too low to sell (<60).</p>`}

                    ${p.age >= 35 ? `
                        <button onclick="retirePlayer(${index})" style="width:100%; background:#8B0000; color:white; margin-bottom:10px;">Force Retirement</button>
                    ` : ''}

                    <button onclick="releasePlayer(${index})" style="width:100%; background:#555; font-size:1rem;">Release (Fee: $${wage*4})</button>
                    <br><br>
                    <button class="close-panel" onclick="document.getElementById('manage-player-modal').classList.remove('active')">Cancel</button>
                </div>
            `;
            modal.innerHTML = html;
            modal.classList.add('active');
        }

        function attemptSellPlayer(index, val) {
            let price = parseInt(document.getElementById('askPrice').value);
            if(!price || price <= 0) return alert("Enter a valid price.");
            
            // Logic: The higher above value, the harder to sell
            let ratio = price / val;
            let chance = 1.0;
            if(ratio > 1) chance = 1 / Math.pow(ratio, 3); // Exponential decay makes it hard to overcharge
            
            if(Math.random() < chance) {
                let p = teamPlayers[index];
                gameState.budget += price;
                teamPlayers.splice(index, 1);
                alert(`SOLD! ${p.name} was bought for $${price.toLocaleString()}.`);
                document.getElementById('manage-player-modal').classList.remove('active');
                showSquadBudget();
            } else {
                alert("No offers received. Try lowering the price.");
            }
        }

        function releasePlayer(index) {
            let p = teamPlayers[index];
            let fee = getPlayerWeeklySalary(p.rating) * 4;
            if(confirm(`Release ${p.name}? You must pay a severance fee of $${fee}.`)) {
                gameState.budget -= fee;
                teamPlayers.splice(index, 1);
                document.getElementById('manage-player-modal').classList.remove('active');
                showSquadBudget();
            }
        }

        function retirePlayer(index) {
            if(confirm("Are you sure? This player will leave the club immediately.")) {
                teamPlayers.splice(index, 1);
                document.getElementById('manage-player-modal').classList.remove('active');
                showSquadBudget();
            }
        }
		
		// --- MUSIC PLAYER SYSTEM ---
        
        // ‚ö†Ô∏è EDIT THIS LIST: Add your exact filenames here!
        const playlist = [
            "Brilliant.mp3",
            "Affairs of the Heart.mp3",
			"Baller.mp3",
			"Cold Hell.mp3",
			"Brazasia.mp3",
			"Dont Know Why.mp3",
			"Endlessly.mp3",
			"Fly Boy.mp3",
			"Hear the Night.mp3",
			"Twilight.mp3",
			"Daigoro.mp3",
			"Plastic City.mp3",
            "GDR.mp3"
        ]; 
        
        const musicFolder = "music/"; // The folder name
        let musicIndex = 0;
        let audioPlayer = new Audio();
        let musicStarted = false;

        function initMusicSystem() {
            if (musicStarted || playlist.length === 0) return;
            
            // SHUFFLE PLAYLIST ON START
            for (let i = playlist.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [playlist[i], playlist[j]] = [playlist[j], playlist[i]];
            }
            
            playSong(0);
            musicStarted = true;
            audioPlayer.addEventListener('ended', () => {
                musicIndex = (musicIndex + 1) % playlist.length;
                playSong(musicIndex);
            });
        }

        function playSong(index) {
            let filename = playlist[index];
            audioPlayer.src = musicFolder + filename;
            audioPlayer.volume = 0.2; // Set volume (0.0 to 1.0)
            
            // Play audio (browser requires user interaction first, which happens when they click Start)
            audioPlayer.play().catch(e => console.log("Audio waiting for interaction..."));

            // Show the popup
            showMusicPopup(filename);
        }

        function showMusicPopup(filename) {
            // Remove file extension for cleaner look (removes .mp3)
            let cleanName = filename.replace(/\.[^/.]+$/, "");
            
            document.getElementById('notification-song-name').innerText = cleanName;
            
            let popup = document.getElementById('music-notification');
            popup.classList.add('show');

            // Hide after 4 seconds
            setTimeout(() => {
                popup.classList.remove('show');
            }, 4000);
        }
		
		// --- SAVE SYSTEM ---
        function saveGame(showNotification = false) {
            // 1. Bundle all data into one object
            let saveObj = {
                managerName: document.getElementById('managerName').value,
                selectedLeague, 
                selectedTeam, 
                teamPlayers, 
                leagueTeams, 
                leagueStandings, 
                schedule, 
                currentMatchIndex, 
                gameState, 
                usasaSigningsCount,
                matchHalf,
                firstHalfResult,
                // Add Tournament Data to Save File
                pendingQualifiers: (typeof pendingQualifiers !== 'undefined') ? pendingQualifiers : {},
                seasonQualifiers: (typeof seasonQualifiers !== 'undefined') ? seasonQualifiers : {}
            };

            // 2. Save to Browser Memory
            try {
                localStorage.setItem('asm2026_save', JSON.stringify(saveObj));
                if (showNotification) {
                    alert("Game Saved Successfully!");
                } else {
                    console.log("Auto-save complete.");
                }
            } catch (e) {
                console.log("Save failed! Storage might be full.");
            }
        }

        // --- LOAD SYSTEM ---
        function loadGame() {
            // 1. Check for save file
            let data = localStorage.getItem('asm2026_save');
            if(!data) return alert("No saved game found.");
            
            // 2. Unpack data
            let obj = JSON.parse(data);
            
            // 3. Restore variables
            selectedLeague = obj.selectedLeague;
            selectedTeam = obj.selectedTeam;
            teamPlayers = obj.teamPlayers;
            leagueTeams = obj.leagueTeams;
            leagueStandings = obj.leagueStandings;
            schedule = obj.schedule;
            currentMatchIndex = obj.currentMatchIndex;
            gameState = obj.gameState;
            usasaSigningsCount = obj.usasaSigningsCount || 0;
            matchHalf = obj.matchHalf || 0;
            firstHalfResult = obj.firstHalfResult || null;

            document.getElementById('managerName').value = obj.managerName;

            // 4. Restore UI
            document.getElementById('screen-start').classList.remove('active');
            document.getElementById('screen-matchday').classList.add('active');
            document.getElementById('team-header').innerText = selectedTeam;
            
            // 5. Refresh Displays
            updateMatchInfo();
            displayStarting11();
            
            // If we loaded in the middle of a match (Half Time), show the halftime screen
            if (matchHalf === 1 && firstHalfResult) {
                let match = schedule[currentMatchIndex];
                showHalfTime(match, firstHalfResult, match.competition === "Open Cup");
            }

            alert("Game Loaded!");
        }
    </script>
</body>
</html>
